<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendas - Maiconsoft</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- √çcones Material Design -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/navigation.css">
    <link rel="stylesheet" href="../css/notifications.css">
    
    <style>
        /* Estilos para autocomplete */
        .suggestion-item:hover {
            background-color: #f9fafb !important;
        }
        
        .suggestion-item {
            transition: background-color 0.2s ease;
        }
        
        /* Anima√ß√£o de loading para sugest√µes */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .suggestions-loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* CSS para for√ßar posicionamento correto do modal */
        #edit-venda-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 9999 !important;
            background: rgba(0, 0, 0, 0.7) !important;
            overflow-y: auto !important;
        }

        #edit-venda-modal > div {
            background: white !important;
            margin: 2rem auto !important;
            max-width: 800px !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
            position: relative !important;
            max-height: calc(100vh - 4rem) !important;
            display: flex !important;
            flex-direction: column !important;
        }

        #edit-venda-modal .modal-footer {
            padding: 1.5rem !important;
            background: #f9fafb !important;
            display: flex !important;
            justify-content: flex-end !important;
            align-items: center !important;
            gap: 1rem !important;
            border-top: 1px solid #e5e7eb !important;
            flex-shrink: 0 !important;
            position: relative !important;
            bottom: auto !important;
            left: auto !important;
            right: auto !important;
            width: auto !important;
        }
    </style>
</head>
<body>
    <!-- Container de Alertas -->
    <div id="alert-container"></div>

    <!-- Navigation Bar -->
    <nav style="background: #000000; padding: 1rem 0; box-shadow: 0 2px 20px rgba(0, 0, 0, 0.8); border-bottom: 2px solid #f59e0b;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 2rem;">
            <div style="display: flex; align-items: center;">
                <a href="dashboard.html" style="text-decoration: none;">
                    <img src="../images/teste.webp" alt="Maiconsoft" style="height: 40px; width: auto;">
                </a>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <a href="dashboard.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">dashboard</span>
                    Dashboard
                </a>
                <a href="clientes.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">people</span>
                    Clientes
                </a>
                <a href="vendas.html" style="color: #000000; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; background: #f59e0b; font-weight: 600; border-radius: 6px;">
                    <span class="material-icons" style="font-size: 1.1rem;">trending_up</span>
                    Vendas
                </a>
                <a href="cupons.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">local_offer</span>
                    Cupons
                </a>
                <a href="usuarios.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">group</span>
                    Usu√°rios
                </a>
                <a href="relatorios.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">assessment</span>
                    Relat√≥rios
                </a>
                
                <!-- Menu do Usu√°rio -->
                <div style="position: relative; display: inline-block;">
                    <button id="userMenuBtn" onclick="toggleUserMenu()" style="background: #333333; color: #ffffff; border: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; cursor: pointer; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#444444'" onmouseout="this.style.background='#333333'">
                        <span class="material-icons" style="font-size: 1.1rem;">account_circle</span>
                        <span id="userName">Usu√°rio</span>
                        <span class="material-icons" style="font-size: 1rem;">arrow_drop_down</span>
                    </button>
                    
                    <div id="userDropdown" style="display: none; position: absolute; right: 0; top: 100%; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border-radius: 8px; min-width: 200px; z-index: 1000; border: 1px solid #e5e7eb; margin-top: 0.5rem;">
                        <div style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;" id="userNameDisplay">Nome do Usu√°rio</div>
                            <div style="font-size: 0.8rem; color: #6b7280;" id="userRoleDisplay">Cargo</div>
                        </div>
                        
                        <a href="perfil.html" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #374151; text-decoration: none; transition: all 0.3s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                            <span class="material-icons" style="font-size: 1.1rem; color: #3b82f6;">person</span>
                            Meu Perfil
                        </a>
                        
                        <a href="perfil.html#configuracoes" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #374151; text-decoration: none; transition: all 0.3s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                            <span class="material-icons" style="font-size: 1.1rem; color: #6b7280;">settings</span>
                            Configura√ß√µes
                        </a>
                        
                        <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0;"></div>
                        
                        <a href="#" onclick="fazerLogout()" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #ef4444; text-decoration: none; transition: all 0.3s;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='transparent'">
                            <span class="material-icons" style="font-size: 1.1rem;">logout</span>
                            Sair do Sistema
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Container Principal -->
    <div style="max-width: 1200px; margin: 0 auto; padding: 2rem; background: #f8fafc; min-height: calc(100vh - 70px);">
        
        <!-- Header da P√°gina -->
        <div style="background: white; padding: 1.5rem 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem; border-left: 4px solid #3b82f6;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h1 style="margin: 0 0 0.5rem 0; font-size: 1.75rem; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 0.75rem;">
                        <span class="material-icons" style="font-size: 1.75rem; color: #3b82f6;">trending_up</span>
                        Gest√£o de Vendas
                    </h1>
                    <p style="margin: 0; color: #6b7280; font-size: 0.95rem;">Controle completo de vendas, or√ßamentos e performance comercial</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="switchVendasTab('resumo')" id="tab-resumo-btn" style="background: #3b82f6; color: white; border: none; padding: 0.6rem 1.2rem; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1rem;">dashboard</span>
                        Resumo
                    </button>
                    <button onclick="switchVendasTab('nova')" id="tab-nova-btn" style="background: transparent; color: #6b7280; border: none; padding: 0.6rem 1.2rem; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1rem;">add_circle</span>
                        Nova Venda
                    </button>
                    <button onclick="switchVendasTab('lista')" id="tab-lista-btn" style="background: transparent; color: #6b7280; border: none; padding: 0.6rem 1.2rem; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1rem;">list</span>
                        Todas Vendas
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB: RESUMO DE VENDAS -->
        <div id="tab-resumo" class="vendas-tab-content" style="display: block;">
            <!-- M√©tricas Principais -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div style="background: white; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #10b981;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; font-size: 0.85rem; color: #6b7280; font-weight: 500;">Total de Vendas</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="total-vendas">R$ 0</h3>
                        </div>
                        <div style="background: #d1fae5; padding: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: #10b981; font-size: 1.5rem;">monetization_on</span>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #3b82f6;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; font-size: 0.85rem; color: #6b7280; font-weight: 500;">Vendas Este M√™s</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="vendas-mes">0</h3>
                        </div>
                        <div style="background: #dbeafe; padding: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: #3b82f6; font-size: 1.5rem;">trending_up</span>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #f59e0b;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; font-size: 0.85rem; color: #6b7280; font-weight: 500;">Or√ßamentos Pendentes</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="orcamentos-pendentes">0</h3>
                        </div>
                        <div style="background: #fef3c7; padding: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: #f59e0b; font-size: 1.5rem;">pending</span>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #8b5cf6;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; font-size: 0.85rem; color: #6b7280; font-weight: 500;">Ticket M√©dio</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="ticket-medio">R$ 0</h3>
                        </div>
                        <div style="background: #ede9fe; padding: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: #8b5cf6; font-size: 1.5rem;">analytics</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vendas Recentes -->
            <div style="background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1.2rem; color: #10b981;">receipt_long</span>
                        Vendas Recentes
                    </h3>
                </div>
                <div style="padding: 1.5rem;">
                    <div id="vendas-recentes" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Dados carregados via JavaScript -->
                    </div>
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button onclick="switchVendasTab('lista')" style="background: #3b82f6; color: white; border: none; padding: 0.7rem 1.5rem; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 1rem;">list</span>
                            Ver Todas as Vendas
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: NOVA VENDA -->
        <div id="tab-nova" class="vendas-tab-content" style="display: none;">
            <div style="background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <form id="nova-venda-form" style="padding: 0;">
                    <!-- Dados da Venda -->
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 1.2rem; color: #3b82f6;">add_shopping_cart</span>
                            Informa√ß√µes da Venda
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div style="position: relative;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Cliente *</label>
                                <input type="text" 
                                       id="cliente-search" 
                                       placeholder="Digite o nome do cliente..." 
                                       autocomplete="off"
                                       required 
                                       style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem; background: white;">
                                <input type="hidden" id="cliente-id" name="clienteId">
                                
                                <!-- Lista de sugest√µes -->
                                <div id="cliente-suggestions" 
                                     style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Data da Venda</label>
                                <input type="date" id="data-venda" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Valor Total *</label>
                                <input type="text" id="valor-venda" required style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem;" placeholder="R$ 0,00">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Cupom de Desconto</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <select id="cupom-desconto" name="cupom" style="flex: 1; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem; background: white;">
                                        <option value="">Nenhum cupom</option>
                                        <!-- Cupons carregados via JavaScript -->
                                    </select>
                                    <button type="button" onclick="recarregarCupons()" title="Atualizar lista de cupons" 
                                            style="background: #10b981; color: white; border: none; padding: 0.6rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 40px; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='#059669'" 
                                            onmouseout="this.style.background='#10b981'">
                                        <span class="material-icons" style="font-size: 1.1rem;">refresh</span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Forma de Pagamento</label>
                                <select id="forma-pagamento" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem; background: white;">
                                    <option value="">Selecionar</option>
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="cartao_debito">Cart√£o de D√©bito</option>
                                    <option value="cartao_credito">Cart√£o de Cr√©dito</option>
                                    <option value="pix">PIX</option>
                                    <option value="transferencia">Transfer√™ncia</option>
                                    <option value="boleto">Boleto</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Status</label>
                                <select id="status-venda" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem; background: white;">
                                    <option value="PENDENTE">Pendente</option>
                                    <option value="CONFIRMADA">Confirmada</option>
                                    <option value="CANCELADA">Cancelada</option>
                                    <option value="FINALIZADA">Finalizada</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Descri√ß√£o/Observa√ß√µes</label>
                            <textarea id="descricao-venda" rows="3" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem; resize: vertical;" placeholder="Descreva os produtos/servi√ßos vendidos e observa√ß√µes importantes"></textarea>
                        </div>
                    </div>

                    <!-- Bot√µes de A√ß√£o -->
                    <div style="padding: 1.5rem; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <button type="button" onclick="limparFormularioVenda()" style="background: #ef4444; color: white; border: none; padding: 0.7rem 1.2rem; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 1rem;">clear</span>
                            Limpar
                        </button>
                        
                        <div style="display: flex; gap: 0.75rem;">
                            <button type="button" onclick="salvarRascunhoVenda()" style="background: #f59e0b; color: white; border: none; padding: 0.7rem 1.2rem; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="font-size: 1rem;">save</span>
                                Rascunho
                            </button>
                            <button type="submit" style="background: #10b981; color: white; border: none; padding: 0.7rem 1.5rem; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="font-size: 1rem;">add_shopping_cart</span>
                                Registrar Venda
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- TAB: LISTA DE VENDAS -->
        <div id="tab-lista" class="vendas-tab-content" style="display: none;">
            <div style="background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <!-- Filtros e Busca -->
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #374151;">Todas as Vendas</h3>
                        <div style="display: flex; gap: 1rem;">
                            <input type="text" id="search-vendas" placeholder="Buscar por cliente, valor..." style="padding: 0.6rem 1rem; border: 1px solid #d1d5db; font-size: 0.9rem; min-width: 250px;">
                            <button style="background: #3b82f6; color: white; border: none; padding: 0.6rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="font-size: 1rem;">search</span>
                                Buscar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Vendas -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f9fafb;">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">ID</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Cliente</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Valor</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Status</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Data</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="sales-tbody">
                            <!-- Dados carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Venda -->
    <div id="edit-venda-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; overflow-y: auto;">
        <div style="background: white; margin: 2rem auto; max-width: 800px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); position: relative; max-height: calc(100vh - 4rem); display: flex; flex-direction: column;">
            <!-- Header do Modal -->
            <div style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="material-icons" style="font-size: 1.3rem; color: #3b82f6;">edit</span>
                    Editar Venda
                </h3>
                <button onclick="closeEditModal()" style="background: none; border: none; cursor: pointer; padding: 0.5rem; color: #6b7280; transition: color 0.3s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#6b7280'">
                    <span class="material-icons" style="font-size: 1.5rem;">close</span>
                </button>
            </div>

            <!-- Formul√°rio de Edi√ß√£o -->
            <form id="edit-venda-form" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
                <!-- Dados da Venda -->
                <div style="padding: 2rem; flex: 1; overflow-y: auto;">
                    <h4 style="margin: 0 0 1.5rem 0; font-size: 1rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1.1rem; color: #3b82f6;">shopping_cart</span>
                        Informa√ß√µes da Venda
                    </h4>
                    
                    <input type="hidden" id="edit-venda-id">
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="position: relative;">
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Cliente *</label>
                            <input type="text" 
                                   id="edit-cliente-search" 
                                   placeholder="Digite o nome do cliente..." 
                                   autocomplete="off"
                                   required 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white; transition: border-color 0.3s;">
                            <input type="hidden" id="edit-cliente-id" name="clienteId">
                            
                            <!-- Lista de sugest√µes -->
                            <div id="edit-cliente-suggestions" 
                                 style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Data da Venda</label>
                            <input type="date" id="edit-data-venda" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Valor Total *</label>
                            <input type="text" id="edit-valor-venda" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white;" placeholder="R$ 0,00">
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Forma de Pagamento</label>
                            <select id="edit-forma-pagamento" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white;">
                                <option value="">Selecionar</option>
                                <option value="dinheiro">Dinheiro</option>
                                <option value="cartao_debito">Cart√£o de D√©bito</option>
                                <option value="cartao_credito">Cart√£o de Cr√©dito</option>
                                <option value="pix">PIX</option>
                                <option value="transferencia">Transfer√™ncia</option>
                                <option value="boleto">Boleto</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Status</label>
                            <select id="edit-status-venda" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white;">
                                <option value="PENDENTE">Pendente</option>
                                <option value="CONFIRMADA">Confirmada</option>
                                <option value="CANCELADA">Cancelada</option>
                                <option value="FINALIZADA">Finalizada</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Descri√ß√£o/Observa√ß√µes</label>
                        <textarea id="edit-descricao-venda" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; resize: vertical; background: white; font-family: inherit;" placeholder="Descreva os produtos/servi√ßos vendidos e observa√ß√µes importantes"></textarea>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="modal-footer" style="padding: 1.5rem 2rem; background: #f9fafb; display: flex; justify-content: flex-end; align-items: center; gap: 1rem; border-top: 1px solid #e5e7eb; flex-shrink: 0; border-radius: 0 0 12px 12px;">
                    <button type="button" onclick="closeEditModal()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; border-radius: 6px; transition: background-color 0.3s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                        <span class="material-icons" style="font-size: 1rem;">cancel</span>
                        Cancelar
                    </button>
                    <button type="submit" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; border-radius: 6px; transition: background-color 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                        <span class="material-icons" style="font-size: 1rem;">save</span>
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Fun√ß√£o para alternar entre tabs de vendas
        function switchVendasTab(tabName) {
            console.log('switchVendasTab chamado com:', tabName);
            
            // Ocultar todas as tabs
            const tabs = document.querySelectorAll('.vendas-tab-content');
            tabs.forEach(tab => tab.style.display = 'none');
            
            // Remover estilo ativo dos bot√µes
            const buttons = ['tab-resumo-btn', 'tab-nova-btn', 'tab-lista-btn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.background = 'transparent';
                    btn.style.color = '#6b7280';
                }
            });
            
            // Mostrar tab selecionada e ativar bot√£o
            const activeTab = document.getElementById(`tab-${tabName}`);
            const activeBtn = document.getElementById(`tab-${tabName}-btn`);
            
            if (activeTab && activeBtn) {
                activeTab.style.display = 'block';
                activeBtn.style.background = '#3b82f6';
                activeBtn.style.color = 'white';
            }
        }

        // Disponibilizar fun√ß√£o globalmente
        window.switchVendasTab = switchVendasTab;

        // Fun√ß√£o de logout com notifica√ß√£o moderna
        function fazerLogout() {
            // Mostrar notifica√ß√£o de logout
            showLogoutNotification();
            
            // Executar logout ap√≥s 1.5 segundos
            setTimeout(() => {
                localStorage.removeItem('usuarioLogado');
                window.location.href = 'login.html';
            }, 1500);
        }
        
        function showLogoutNotification() {
            // Criar overlay de logout
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            // Criar card de logout
            const logoutCard = document.createElement('div');
            logoutCard.style.cssText = `
                background: #1a1a1a;
                border: 2px solid #f59e0b;
                border-radius: 16px;
                padding: 2rem;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                animation: slideIn 0.4s ease-out;
                max-width: 350px;
            `;
            
            logoutCard.innerHTML = `
                <div style="color: #f59e0b; font-size: 3rem; margin-bottom: 1rem;">
                    <span class="material-icons" style="font-size: 3rem;">logout</span>
                </div>
                <h3 style="color: white; margin: 0 0 0.5rem 0; font-size: 1.3rem; font-weight: 600;">
                    Saindo do sistema...
                </h3>
                <p style="color: #cccccc; margin: 0 0 1.5rem 0; font-size: 0.9rem;">
                    Obrigado por usar o Sistema Maiconsoft!
                </p>
                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: #f59e0b;">
                    <div class="loading-spinner"></div>
                    <span style="font-size: 0.85rem; font-weight: 500;">Redirecionando...</span>
                </div>
            `;
            
            overlay.appendChild(logoutCard);
            document.body.appendChild(overlay);
            
            // Adicionar estilos de anima√ß√£o
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes slideIn {
                    from { transform: scale(0.8) translateY(-20px); opacity: 0; }
                    to { transform: scale(1) translateY(0); opacity: 1; }
                }
                
                .loading-spinner {
                    width: 16px;
                    height: 16px;
                    border: 2px solid #333;
                    border-top: 2px solid #f59e0b;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                }
                
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }

        // Check authentication and permissions
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se usu√°rio est√° logado
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            if (!usuarioLogado) {
                window.location.href = 'login.html';
                return;
            }
            
            const usuario = JSON.parse(usuarioLogado);
            console.log('Usu√°rio logado:', usuario);
            
            // Liberar acesso para todos os usu√°rios logados
            // Comentado para evitar erros - AppState n√£o existe
            // const user = AppState.user;
            // const userRole = user?.perfil?.toLowerCase();
            
            // Configurar data padr√£o para hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('data-venda').value = hoje;
            
            loadVendasData();
            
            // Wait for APIService to be loaded
            if (window.APIService) {
                setupClienteAutocomplete();
                loadCuponsDisponiveis();
            } else {
                console.warn('‚ö†Ô∏è APIService n√£o carregado ainda, tentando novamente...');
                setTimeout(() => {
                    if (window.APIService) {
                        setupClienteAutocomplete();
                        loadCuponsDisponiveis();
                    } else {
                        console.error('‚ùå APIService n√£o p√¥de ser carregado');
                    }
                }, 100);
            }
            
            loadMetricas();
            
            // Setup valor formatting
            const valorInput = document.getElementById('valor-venda');
            if (valorInput) {
                valorInput.addEventListener('input', function() {
                    let value = this.value.replace(/[^\d,]/g, '');
                    if (value) {
                        // Add R$ prefix if not empty
                        this.value = 'R$ ' + value;
                    }
                });
                
                valorInput.addEventListener('blur', function() {
                    let value = this.value.replace(/[^\d,]/g, '');
                    if (value && !value.includes(',')) {
                        // Add ,00 if no decimal part
                        this.value = 'R$ ' + value + ',00';
                    }
                });
            }
        });

        // Fun√ß√£o para mostrar alertas
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            if (!alertContainer) {
                // Criar container se n√£o existir
                const container = document.createElement('div');
                container.id = 'alert-container';
                container.style.cssText = 'position: fixed; top: 0; right: 0; z-index: 10000; pointer-events: none;';
                document.body.appendChild(container);
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10001;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                pointer-events: auto;
                transform: translateX(400px);
                transition: transform 0.3s ease-out;
            `;
            alertDiv.textContent = message;
            
            document.body.appendChild(alertDiv);
            
            // Animar entrada
            setTimeout(() => {
                alertDiv.style.transform = 'translateX(0)';
            }, 10);
            
            // Remover ap√≥s 4 segundos
            setTimeout(() => {
                alertDiv.style.transform = 'translateX(400px)';
                setTimeout(() => alertDiv.remove(), 300);
            }, 4000);
        }

        
        async function loadMetricas() {
            try {
                console.log('üìä Carregando m√©tricas de vendas...');
                
                // Buscar dados reais das vendas
                const response = await APIService.vendas.getAll(0, 100); // Buscar muitas vendas para calcular m√©tricas
                const vendas = response.vendas || response.content || [];
                
                console.log('üìà Vendas carregadas:', vendas.length);
                
                // Calcular m√©tricas baseadas nos dados reais
                const totalVendas = vendas.reduce((sum, venda) => {
                    if (venda.status === 'FINALIZADA') {
                        return sum + (venda.valorTotal || venda.valorVenda || 0);
                    }
                    return sum;
                }, 0);
                
                const vendasFinalizadas = vendas.filter(venda => venda.status === 'FINALIZADA').length;
                const orcamentosPendentes = vendas.filter(venda => venda.status === 'PENDENTE').length;
                const ticketMedio = vendasFinalizadas > 0 ? totalVendas / vendasFinalizadas : 0;
                
                // Atualizar interface
                document.getElementById('total-vendas').textContent = `R$ ${totalVendas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('vendas-mes').textContent = vendasFinalizadas.toString();
                document.getElementById('orcamentos-pendentes').textContent = orcamentosPendentes.toString();
                document.getElementById('ticket-medio').textContent = `R$ ${ticketMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                
                console.log('‚úÖ M√©tricas atualizadas com dados reais');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar m√©tricas:', error);
                // Fallback para valores padr√£o em caso de erro
                document.getElementById('total-vendas').textContent = 'R$ 0,00';
                document.getElementById('vendas-mes').textContent = '0';
                document.getElementById('orcamentos-pendentes').textContent = '0';
                document.getElementById('ticket-medio').textContent = 'R$ 0,00';
            }
        }
        
        async function loadVendasData() {
            try {
                console.log('üìã Carregando dados de vendas...');
                
                // Buscar vendas reais da API
                const response = await APIService.vendas.getAll(0, 20); // Buscar √∫ltimas 20 vendas
                const vendas = response.vendas || response.content || [];
                
                console.log('üìä Vendas carregadas:', vendas.length, vendas);
                
                // Mapear dados para o formato esperado pelo frontend
                const vendasFormatadas = vendas.map(venda => ({
                    id: venda.idVenda || venda.id,
                    cliente: venda.clienteNome || venda.cliente?.nome || 'Cliente n√£o informado',
                    valor: venda.valorTotal || venda.valorVenda || 0,
                    status: getStatusPortugues(venda.status || venda.statusVenda),
                    data: venda.dataVenda || venda.datahoraCadastro || new Date().toISOString(),
                    descricao: venda.observacao || venda.descricao || 'Sem descri√ß√£o',
                    numeroOrcamento: venda.numeroOrcamento || `#${String(venda.idVenda || venda.id).padStart(4, '0')}`
                }));
                
                // Load recent sales (resumo)
                const recentSales = document.getElementById('vendas-recentes');
                if (recentSales) {
                    if (vendasFormatadas.length === 0) {
                        recentSales.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Nenhuma venda encontrada</p>';
                    } else {
                        recentSales.innerHTML = vendasFormatadas.slice(0, 5).map(venda => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border: 1px solid #e5e7eb; background: #f9fafb;">
                                <div>
                                    <p style="margin: 0; font-weight: 600; color: #1f2937; font-size: 0.9rem;">${venda.cliente}</p>
                                    <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.8rem;">${venda.descricao}</p>
                                    <p style="margin: 0.25rem 0 0 0; color: #9ca3af; font-size: 0.75rem;">${venda.numeroOrcamento}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="margin: 0; font-weight: 700; color: #10b981; font-size: 0.95rem;">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                                    <span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: ${getStatusColor(venda.status)}; color: white; font-weight: 500;">${venda.status}</span>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                // Load all sales (lista)
                const allSales = document.getElementById('sales-tbody');
                if (allSales) {
                    if (vendasFormatadas.length === 0) {
                        allSales.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; color: #6b7280; padding: 2rem;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                                        <span class="material-icons" style="font-size: 3rem; color: #d1d5db;">receipt_long</span>
                                        <p style="margin: 0; font-size: 1.1rem;">Nenhuma venda encontrada</p>
                                        <p style="margin: 0; font-size: 0.9rem; color: #9ca3af;">Clique em "Nova Venda" para registrar a primeira venda</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        allSales.innerHTML = vendasFormatadas.map(venda => `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600; color: #1f2937;">${venda.numeroOrcamento}</td>
                                <td style="padding: 0.75rem; color: #374151;">${venda.cliente}</td>
                                <td style="padding: 0.75rem; font-weight: 600; color: #10b981;">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                <td style="padding: 0.75rem;">
                                    <span style="font-size: 0.8rem; padding: 0.3rem 0.6rem; border-radius: 4px; background: ${getStatusColor(venda.status)}; color: white; font-weight: 500;">
                                        ${venda.status}
                                    </span>
                                </td>
                                <td style="padding: 0.75rem; color: #6b7280; font-size: 0.9rem;">${formatarData(venda.data)}</td>
                                <td style="padding: 0.75rem;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button onclick="editVenda(${venda.id})" style="background: #3b82f6; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Editar">
                                            <span class="material-icons" style="font-size: 0.9rem;">edit</span>
                                        </button>
                                        <button onclick="deleteVenda(${venda.id})" style="background: #ef4444; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Excluir">
                                            <span class="material-icons" style="font-size: 0.9rem;">delete</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
                
                console.log('‚úÖ Dados de vendas carregados e exibidos');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados de vendas:', error);
                
                // Atualizar interface com mensagem de erro
                const recentSales = document.getElementById('vendas-recentes');
                if (recentSales) {
                    recentSales.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 2rem;">
                            <span class="material-icons" style="font-size: 2rem; margin-bottom: 1rem;">error</span>
                            <p style="margin: 0;">Erro ao carregar vendas: ${error.message}</p>
                        </div>
                    `;
                }
                
                const allSales = document.getElementById('sales-tbody');
                if (allSales) {
                    allSales.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #ef4444; padding: 2rem;">
                                Erro ao carregar vendas: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        // Fun√ß√£o para formatar data
        function formatarData(dataString) {
            if (!dataString) return 'Data n√£o informada';
            
            try {
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR');
            } catch (error) {
                console.warn('Erro ao formatar data:', dataString);
                return 'Data inv√°lida';
            }
        }
        
        // Fun√ß√£o para deletar venda
        async function deleteVenda(id) {
            if (!confirm('Tem certeza que deseja excluir esta venda? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Excluindo venda:', id);
                
                await APIService.vendas.delete(id);
                showAlert('‚úÖ Venda exclu√≠da com sucesso!', 'success');
                
                // Recarregar dados
                await loadVendasData();
                await loadMetricas();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir venda:', error);
                showAlert('‚ùå Erro ao excluir venda: ' + error.message, 'error');
            }
        }
        
        // Fun√ß√£o auxiliar para converter status do backend para portugu√™s
        function getStatusPortugues(status) {
            const statusMap = {
                'PENDENTE': 'Pendente',
                'CONFIRMADA': 'Confirmada',
                'CANCELADA': 'Cancelada',
                'FINALIZADA': 'Finalizada'
            };
            return statusMap[status] || status || 'Indefinido';
        }
        
        function getStatusColor(status) {
            switch(status?.toUpperCase()) {
                case 'FINALIZADA':
                    return '#10b981';
                case 'CONFIRMADA': 
                    return '#3b82f6';
                case 'PENDENTE': 
                    return '#f59e0b';
                case 'CANCELADA':
                    return '#ef4444';
                default: 
                    return '#6b7280';
            }
        }
        
        // Configurar autocomplete para clientes
        function setupClienteAutocomplete() {
            setupAutocompleteField('cliente-search', 'cliente-id', 'cliente-suggestions');
            setupAutocompleteField('edit-cliente-search', 'edit-cliente-id', 'edit-cliente-suggestions');
        }

        function setupAutocompleteField(inputId, hiddenId, suggestionsId) {
            const input = document.getElementById(inputId);
            const hiddenInput = document.getElementById(hiddenId);
            const suggestions = document.getElementById(suggestionsId);
            
            if (!input || !hiddenInput || !suggestions) return;
            
            // Check if APIService is loaded
            if (!window.APIService) {
                console.error('‚ùå APIService n√£o est√° carregado para', inputId);
                return;
            }

            let searchTimeout;
            let selectedIndex = -1;

            // Buscar clientes enquanto digita
            input.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                // Reset visual state when user starts typing
                this.style.borderColor = '#d1d5db';
                this.style.backgroundColor = 'white';
                hiddenInput.value = '';
                
                clearTimeout(searchTimeout);
                
                if (searchTerm.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(async () => {
                    await searchClientes(searchTerm, suggestions, input, hiddenInput);
                }, 300);
            });

            // Navega√ß√£o com teclado
            input.addEventListener('keydown', function(e) {
                const items = suggestions.querySelectorAll('.suggestion-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items, selectedIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items, selectedIndex);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        selectCliente(items[selectedIndex], input, hiddenInput, suggestions);
                    }
                } else if (e.key === 'Escape') {
                    suggestions.style.display = 'none';
                    selectedIndex = -1;
                }
            });

            // Ocultar sugest√µes ao clicar fora
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                    selectedIndex = -1;
                }
            });
        }

        async function searchClientes(searchTerm, suggestions, input, hiddenInput) {
            try {
                console.log('üîç Buscando clientes:', searchTerm);
                
                // Debug APIService
                console.log('üîß APIService:', window.APIService);
                console.log('üîß APIService.clientes:', window.APIService?.clientes);
                console.log('üîß APIService.clientes.search:', window.APIService?.clientes?.search);
                
                if (!window.APIService || !window.APIService.clientes || !window.APIService.clientes.search) {
                    throw new Error('APIService n√£o est√° carregado corretamente');
                }
                
                const response = await APIService.clientes.search(searchTerm, 0, 10);
                const clientes = response.content || response.clientes || [];
                
                if (clientes.length === 0) {
                    suggestions.innerHTML = '<div style="padding: 0.75rem; color: #6b7280; font-style: italic;">Nenhum cliente encontrado</div>';
                } else {
                    suggestions.innerHTML = clientes.map(cliente => {
                        const clienteId = cliente.idCliente || cliente.id;
                        const clienteNome = cliente.razaoSocial || cliente.nomeFantasia || cliente.nome || 'Cliente sem nome';
                        const clienteCodigo = cliente.codigo || '';
                        const clienteCpfCnpj = cliente.cpfCnpj || '';
                        const clienteEmail = cliente.email || '';
                        const clienteTelefone = cliente.telefone || '';
                        const clienteCidade = cliente.cidade || '';
                        
                        // Formata√ß√£o do CPF/CNPJ para exibi√ß√£o
                        let cpfCnpjFormatado = '';
                        if (clienteCpfCnpj) {
                            if (clienteCpfCnpj.length === 11) {
                                // CPF: 000.000.000-00
                                cpfCnpjFormatado = clienteCpfCnpj.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                            } else if (clienteCpfCnpj.length === 14) {
                                // CNPJ: 00.000.000/0000-00
                                cpfCnpjFormatado = clienteCpfCnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                            } else {
                                cpfCnpjFormatado = clienteCpfCnpj;
                            }
                        }
                        
                        return `
                            <div class="suggestion-item" 
                                 data-id="${clienteId}" 
                                 data-nome="${clienteNome}"
                                 style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; hover:background-color: #f9fafb;">
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                                    ${clienteNome}
                                    ${clienteCodigo ? `<span style="color: #6b7280; font-weight: 400; margin-left: 0.5rem;">(C√≥d: ${clienteCodigo})</span>` : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: #6b7280; line-height: 1.4;">
                                    ${cpfCnpjFormatado ? `üÜî ${cpfCnpjFormatado}` : ''}
                                    ${clienteEmail ? ` ‚Ä¢ üìß ${clienteEmail}` : ''}
                                    ${clienteTelefone ? ` ‚Ä¢ üìû ${clienteTelefone}` : ''}
                                    ${clienteCidade ? ` ‚Ä¢ üìç ${clienteCidade}` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Adicionar eventos de clique
                    suggestions.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', () => {
                            selectCliente(item, input, hiddenInput, suggestions);
                        });
                        
                        item.addEventListener('mouseenter', () => {
                            updateSelection(suggestions.querySelectorAll('.suggestion-item'), Array.from(suggestions.querySelectorAll('.suggestion-item')).indexOf(item));
                        });
                    });
                }
                
                suggestions.style.display = 'block';
            } catch (error) {
                console.error('Erro ao buscar clientes:', error);
                suggestions.innerHTML = '<div style="padding: 0.75rem; color: #ef4444;">Erro ao buscar clientes</div>';
                suggestions.style.display = 'block';
            }
        }

        function selectCliente(item, input, hiddenInput, suggestions) {
            const clienteId = item.dataset.id;
            const clienteNome = item.dataset.nome;
            
            input.value = clienteNome;
            hiddenInput.value = clienteId;
            suggestions.style.display = 'none';
            
            // Adicionar indica√ß√£o visual de que o cliente foi selecionado
            input.style.borderColor = '#10b981';
            input.style.backgroundColor = '#f0fdf4';
            
            console.log('‚úÖ Cliente selecionado:', { id: clienteId, nome: clienteNome });
        }

        // Fun√ß√£o para carregar cupons dispon√≠veis
        async function loadCuponsDisponiveis() {
            try {
                console.log('üìã Carregando cupons dispon√≠veis...');
                
                const cupomSelect = document.getElementById('cupom-desconto');
                if (cupomSelect) {
                    // Carregar cupons do backend
                    const API_BASE_URL = window.API_BASE_URL || window.CONFIG?.API_BASE_URL || 'http://localhost:8090/api';
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/cupons?page=0&size=100&sortBy=nome&sortDir=asc`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            const cupons = data.content || [];
                            
                            // Filtrar apenas cupons ativos e n√£o expirados
                            const cuponsAtivos = cupons.filter(cupom => 
                                cupom.ativo && 
                                !cupom.expirado && 
                                !cupom.limiteEsgotado &&
                                cupom.status === 'ATIVO'
                            );
                            
                            // Limpar op√ß√µes existentes (exceto "Nenhum cupom")
                            cupomSelect.innerHTML = '<option value="">Nenhum cupom</option>';
                            
                            // Adicionar cupons dispon√≠veis do backend
                            cuponsAtivos.forEach(cupom => {
                                const option = document.createElement('option');
                                option.value = cupom.codigo;
                                
                                // Formatar desconto
                                let desconto = '';
                                if (cupom.descontoPercentual) {
                                    desconto = `${cupom.descontoPercentual}%`;
                                } else if (cupom.descontoValor) {
                                    desconto = `R$ ${cupom.descontoValor.toFixed(2)}`;
                                }
                                
                                // Adicionar informa√ß√µes adicionais
                                let info = '';
                                if (cupom.valorMinimo) {
                                    info += ` - M√≠n: R$ ${cupom.valorMinimo.toFixed(2)}`;
                                }
                                if (cupom.maxUsos && cupom.usosAtuais !== null) {
                                    const restantes = cupom.maxUsos - (cupom.usosAtuais || 0);
                                    info += ` - Restam: ${restantes}`;
                                }
                                
                                option.textContent = `${cupom.codigo} - ${cupom.nome} (${desconto})${info}`;
                                option.title = cupom.descricao || '';
                                cupomSelect.appendChild(option);
                            });
                            
                            console.log(`‚úÖ ${cuponsAtivos.length} cupons ativos carregados do backend`);
                            
                        } else {
                            throw new Error(`Erro na API: ${response.status}`);
                        }
                        
                    } catch (apiError) {
                        console.warn('‚ö†Ô∏è API n√£o dispon√≠vel, usando cupons fixos:', apiError);
                        
                        // Fallback: cupons fixos se a API n√£o estiver dispon√≠vel
                        const cuponsFixos = [
                            { codigo: 'BEMVINDO10', nome: 'Boas-vindas', desconto: '10%' },
                            { codigo: 'FIDELIDADE15', nome: 'Cliente Fiel', desconto: '15%' },
                            { codigo: 'PROMO20', nome: 'Promo√ß√£o Especial', desconto: '20%' }
                        ];
                        
                        // Limpar op√ß√µes existentes (exceto "Nenhum cupom")
                        cupomSelect.innerHTML = '<option value="">Nenhum cupom</option>';
                        
                        // Adicionar cupons fixos
                        cuponsFixos.forEach(cupom => {
                            const option = document.createElement('option');
                            option.value = cupom.codigo;
                            option.textContent = `${cupom.codigo} - ${cupom.nome} (${cupom.desconto})`;
                            cupomSelect.appendChild(option);
                        });
                        
                        console.log(`‚úÖ ${cuponsFixos.length} cupons fixos carregados (fallback)`);
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar cupons:', error);
            }
        }

        // Fun√ß√£o para recarregar cupons manualmente
        async function recarregarCupons() {
            const button = event?.target.closest('button');
            const icon = button?.querySelector('.material-icons');
            
            if (icon) {
                icon.style.animation = 'spin 1s linear infinite';
                button.disabled = true;
                button.style.opacity = '0.7';
            }
            
            try {
                await loadCuponsDisponiveis();
                
                // Mostrar feedback visual
                if (window.showNotification) {
                    showNotification('‚úÖ Cupons atualizados!', 'success', 2000);
                } else {
                    console.log('‚úÖ Cupons atualizados!');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao recarregar cupons:', error);
                if (window.showNotification) {
                    showNotification('‚ùå Erro ao atualizar cupons', 'error', 3000);
                }
            } finally {
                if (icon) {
                    setTimeout(() => {
                        icon.style.animation = '';
                        button.disabled = false;
                        button.style.opacity = '1';
                    }, 1000);
                }
            }
        }

        // Adicionar CSS para anima√ß√£o de rota√ß√£o
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        function updateSelection(items, selectedIndex) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.style.backgroundColor = '#3b82f6';
                    item.style.color = 'white';
                } else {
                    item.style.backgroundColor = '';
                    item.style.color = '';
                }
            });
        }
        
        // Fun√ß√µes do formul√°rio
        function limparFormularioVenda() {
            if (confirm('Tem certeza que deseja limpar todos os campos?')) {
                document.getElementById('nova-venda-form').reset();
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('data-venda').value = hoje;
                localStorage.removeItem('rascunho_venda');
            }
        }
        
        function salvarRascunhoVenda() {
            const formData = new FormData(document.getElementById('nova-venda-form'));
            const data = Object.fromEntries(formData);
            localStorage.setItem('rascunho_venda', JSON.stringify(data));
            alert('Rascunho da venda salvo com sucesso!');
        }
        
        // Submiss√£o do formul√°rio
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('nova-venda-form');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const vendaData = Object.fromEntries(formData);
                    
                    // Validar campos obrigat√≥rios usando os novos campos
                    const clienteId = document.getElementById('cliente-id').value;
                    const clienteNome = document.getElementById('cliente-search').value;
                    const valorVenda = document.getElementById('valor-venda').value;
                    
                    console.log('üîç Valida√ß√£o:', {
                        clienteId,
                        clienteNome,
                        valorVenda,
                        formData: vendaData
                    });
                    
                    if (!clienteId) {
                        alert('‚ùå Por favor, selecione um cliente v√°lido da lista de sugest√µes!\n\nDigite o nome do cliente e clique em uma das op√ß√µes que aparecer na lista.');
                        document.getElementById('cliente-search').focus();
                        return;
                    }
                    
                    if (!valorVenda || valorVenda.trim() === '') {
                        alert('‚ùå Por favor, preencha o valor total da venda!');
                        document.getElementById('valor-venda').focus();
                        return;
                    }
                    
                    const submitBtn = this.querySelector('[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="material-icons" style="font-size: 1rem;">hourglass_empty</span> Salvando...';
                    submitBtn.disabled = true;
                    
                    try {
                        console.log('üì§ Enviando venda para API:', vendaData);
                        
                        // Limpar e processar o valor da venda
                        const valorLimpo = valorVenda.replace(/[R$\s\.]/g, '').replace(',', '.');
                        const valorNumerico = parseFloat(valorLimpo);
                        
                        if (isNaN(valorNumerico) || valorNumerico <= 0) {
                            alert('‚ùå Valor da venda inv√°lido! Use formato: R$ 1.500,00');
                            document.getElementById('valor-venda').focus();
                            return;
                        }
                        
                        // Preparar dados para a API
                        const dataVenda = document.getElementById('data-venda').value;
                        const statusVenda = document.getElementById('status-venda').value;
                        const descricaoVenda = document.getElementById('descricao-venda').value;
                        const cupomCodigo = document.getElementById('cupom-desconto').value;
                        
                        const vendaPayload = {
                            clienteId: parseInt(clienteId),
                            valorBruto: valorNumerico,
                            status: statusVenda || 'PENDENTE',
                            dataVenda: dataVenda || new Date().toISOString().split('T')[0],
                            observacao: descricaoVenda || ''
                        };
                        
                        // Adicionar cupom se selecionado
                        if (cupomCodigo && cupomCodigo.trim() !== '') {
                            vendaPayload.cupomCodigo = cupomCodigo.trim();
                            console.log('üé´ Cupom selecionado:', cupomCodigo);
                        }
                        
                        console.log('üìã Payload preparado:', vendaPayload);
                        
                        // Criar venda via API
                        const response = await APIService.vendas.create(vendaPayload);
                        console.log('‚úÖ Venda criada com sucesso:', response);
                        
                        localStorage.removeItem('rascunho_venda');
                        
                        // Mostrar mensagem de sucesso com n√∫mero do or√ßamento
                        const numeroOrcamento = response.numeroOrcamento || `#${response.idVenda}`;
                        showAlert(`‚úÖ Venda registrada com sucesso! Or√ßamento: ${numeroOrcamento}`, 'success');
                        
                        this.reset();
                        const hoje = new Date().toISOString().split('T')[0];
                        document.getElementById('data-venda').value = hoje;
                        
                        // Recarregar dados
                        await loadVendasData();
                        await loadMetricas();
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao criar venda:', error);
                        
                        let errorMessage = 'Erro ao registrar venda. Tente novamente.';
                        if (error.message.includes('Cliente n√£o encontrado')) {
                            errorMessage = 'Cliente selecionado n√£o foi encontrado.';
                        } else if (error.message.includes('valor')) {
                            errorMessage = 'Valor da venda √© inv√°lido.';
                        }
                        
                        showAlert(`‚ùå ${errorMessage}`, 'error');
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }
        });

        // Handler do formul√°rio de edi√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            const editForm = document.getElementById('edit-venda-form');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const submitBtn = this.querySelector('[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="material-icons" style="font-size: 1rem; animation: spin 1s linear infinite;">hourglass_empty</span> Salvando...';
                    submitBtn.disabled = true;
                    
                    try {
                        const formData = new FormData(this);
                        const vendaId = document.getElementById('edit-venda-id').value;
                        
                        // Obter clienteId do campo hidden
                        const clienteId = document.getElementById('edit-cliente-id').value;
                        if (!clienteId) {
                            alert('‚ùå Por favor, selecione um cliente!');
                            return;
                        }
                        
                        const vendaData = {
                            id: vendaId,
                            clienteId: parseInt(clienteId),
                            dataVenda: formData.get('edit-data-venda') || document.getElementById('edit-data-venda').value,
                            valor: parseFloat(document.getElementById('edit-valor-venda').value.replace(/[^\d,]/g, '').replace(',', '.')) || 0,
                            formaPagamento: formData.get('edit-forma-pagamento') || document.getElementById('edit-forma-pagamento').value,
                            status: formData.get('edit-status-venda') || document.getElementById('edit-status-venda').value,
                            descricao: formData.get('edit-descricao-venda') || document.getElementById('edit-descricao-venda').value
                        };
                        
                        console.log('üíæ Atualizando venda:', vendaData);
                        
                        // Tentar atualizar via API
                        try {
                            const response = await apiClient.updateVenda(vendaId, vendaData);
                            console.log('‚úÖ Venda atualizada via API:', response);
                            
                        } catch (apiError) {
                            console.log('‚ö†Ô∏è API indispon√≠vel, simulando sucesso:', apiError);
                            // Simular delay para parecer real
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                        
                        alert('‚úÖ Venda atualizada com sucesso!');
                        
                        // Fechar modal
                        closeEditModal();
                        
                        // Recarregar dados
                        loadVendasData();
                        loadMetricas();
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao atualizar venda:', error);
                        alert('‚ùå Erro ao atualizar venda. Tente novamente.');
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }
        });
        
        async function editVenda(id) {
            console.log('üîÑ Carregando dados da venda para edi√ß√£o:', id);
            
            try {
                // Buscar dados da venda na API
                const venda = await APIService.vendas.getById(id);
                console.log('üìã Dados da venda carregados:', venda);
                
                if (venda) {
                    // Preencher o formul√°rio de edi√ß√£o
                    document.getElementById('edit-venda-id').value = venda.idVenda || venda.id;
                    document.getElementById('edit-data-venda').value = venda.dataVenda ? venda.dataVenda.split('T')[0] : '';
                    document.getElementById('edit-valor-venda').value = venda.valorTotal || venda.valorVenda || 0;
                    document.getElementById('edit-desconto').value = venda.valorDesconto || 0;
                    document.getElementById('edit-status-venda').value = venda.status || 'PENDENTE';
                    document.getElementById('edit-observacoes').value = venda.observacao || '';
                    
                    // Pr√©-preencher o campo de cliente com os dados da venda
                    const editClienteSearch = document.getElementById('edit-cliente-search');
                    const editClienteId = document.getElementById('edit-cliente-id');
                    if (editClienteSearch && editClienteId && venda.cliente) {
                        editClienteSearch.value = venda.cliente.nome || venda.clienteNome || '';
                        editClienteId.value = venda.cliente.idCliente || venda.cliente.id || '';
                    }
                    
                    // Abrir o modal e for√ßar posicionamento correto
                    const modal = document.getElementById('edit-venda-modal');
                    modal.style.display = 'block';
                    
                    // For√ßar CSS correto
                    modal.style.position = 'fixed';
                    modal.style.top = '0';
                    modal.style.left = '0';
                    modal.style.width = '100%';
                    modal.style.height = '100%';
                    modal.style.zIndex = '9999';
                    
                    // Corrigir footer dos bot√µes
                    const footer = modal.querySelector('.modal-footer');
                    if (footer) {
                        footer.style.position = 'relative';
                        footer.style.bottom = 'auto';
                        footer.style.left = 'auto';
                        footer.style.right = 'auto';
                        footer.style.width = 'auto';
                        footer.style.flexShrink = '0';
                    }
                    
                    document.body.style.overflow = 'hidden'; // Impedir scroll do body
                    
                } else {
                    showAlert('‚ùå Erro ao carregar dados da venda!', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar venda para edi√ß√£o:', error);
                showAlert('‚ùå Erro ao carregar dados da venda: ' + error.message, 'error');
            }
        }

        function deleteVenda(id) {
            if (confirm('Tem certeza que deseja excluir esta venda? Esta a√ß√£o n√£o pode ser desfeita.')) {
                console.log('üóëÔ∏è Excluindo venda:', id);
                
                // Implementar exclus√£o via API
                APIService.vendas.delete(id)
                    .then(() => {
                        console.log('‚úÖ Venda exclu√≠da com sucesso');
                        showAlert('‚úÖ Venda exclu√≠da com sucesso!', 'success');
                        
                        // Recarregar dados
                        loadVendasData();
                        loadMetricas();
                    })
                    .catch(error => {
                        console.error('‚ùå Erro ao excluir venda:', error);
                        showAlert('‚ùå Erro ao excluir venda: ' + error.message, 'error');
                    });
            }
        }

        // Fun√ß√£o para fechar o modal de edi√ß√£o
        function closeEditModal() {
            document.getElementById('edit-venda-modal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restaurar scroll do body
        }

        // Fun√ß√£o para deletar venda com confirma√ß√£o melhorada
        function deleteVenda(id) {
            showNotification(
                `Tem certeza que deseja excluir esta venda?`,
                'warning',
                [
                    {
                        text: 'Cancelar',
                        action: () => {/* N√£o faz nada */}
                    },
                    {
                        text: 'Excluir',
                        action: () => confirmarExclusaoVenda(id),
                        class: 'btn-danger'
                    }
                ]
            );
        }

        // Fun√ß√£o para confirmar exclus√£o da venda
        async function confirmarExclusaoVenda(id) {
            try {
                console.log('üóëÔ∏è Excluindo venda:', id);
                
                const response = await fetch(`${API_BASE_URL}/vendas/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Erro ao excluir venda');
                }
                
                showNotification('‚úÖ Venda exclu√≠da com sucesso!', 'success');
                
                // Recarregar dados
                await loadVendasData();
                await loadMetricas();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir venda:', error);
                showNotification('‚ùå Erro ao excluir venda: ' + error.message, 'error');
            }
        }

        // Fun√ß√£o para editar venda
        async function editVenda(id) {
            try {
                console.log('‚úèÔ∏è Carregando venda para edi√ß√£o:', id);
                
                // Buscar dados da venda
                const response = await fetch(`${API_BASE_URL}/vendas/${id}`);
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar venda');
                }
                
                const venda = await response.json();
                console.log('üìä Dados da venda carregados:', venda);
                
                // Preencher modal de edi√ß√£o
                document.getElementById('edit-venda-id').value = venda.idVenda;
                document.getElementById('edit-cliente-search').value = venda.clienteNome || '';
                document.getElementById('edit-cliente-id').value = venda.clienteId || '';
                document.getElementById('edit-valor-venda').value = formatCurrency(venda.valorBruto || 0);
                document.getElementById('edit-status-venda').value = venda.status || 'PENDENTE';
                document.getElementById('edit-data-venda').value = venda.dataVenda || '';
                document.getElementById('edit-descricao-venda').value = venda.observacao || '';
                
                // Selecionar cupom se houver
                const cupomSelect = document.getElementById('edit-cupom-desconto');
                if (venda.cupomCodigo && cupomSelect) {
                    for (let option of cupomSelect.options) {
                        if (option.value === venda.cupomCodigo) {
                            option.selected = true;
                            break;
                        }
                    }
                }
                
                // Mostrar modal e for√ßar posicionamento correto
                const modal = document.getElementById('edit-venda-modal');
                modal.style.display = 'block';
                
                // For√ßar CSS correto
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.zIndex = '9999';
                
                // Corrigir footer dos bot√µes
                const footer = modal.querySelector('.modal-footer');
                if (footer) {
                    footer.style.position = 'relative';
                    footer.style.bottom = 'auto';
                    footer.style.left = 'auto';
                    footer.style.right = 'auto';
                    footer.style.width = 'auto';
                    footer.style.flexShrink = '0';
                }
                
                document.body.style.overflow = 'hidden';
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar venda:', error);
                showNotification('‚ùå Erro ao carregar venda: ' + error.message, 'error');
            }
        }

        // Fun√ß√£o para fechar modal de edi√ß√£o
        function closeEditModal() {
            document.getElementById('edit-venda-modal').style.display = 'none';
        }

        // Event listener para formul√°rio de edi√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            const editForm = document.getElementById('edit-venda-form');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    try {
                        const vendaId = document.getElementById('edit-venda-id').value;
                        const clienteId = document.getElementById('edit-cliente-id').value;
                        const valorInput = document.getElementById('edit-valor-venda').value;
                        const status = document.getElementById('edit-status-venda').value;
                        const dataVenda = document.getElementById('edit-data-venda').value;
                        const observacao = document.getElementById('edit-descricao-venda').value;
                        const cupomCodigo = document.getElementById('edit-cupom-desconto').value;
                        
                        // Valida√ß√µes
                        if (!clienteId) {
                            showNotification('‚ùå Por favor, selecione um cliente v√°lido', 'error');
                            return;
                        }
                        
                        if (!valorInput) {
                            showNotification('‚ùå Por favor, informe o valor da venda', 'error');
                            return;
                        }
                        
                        // Converter valor para n√∫mero
                        const valorBruto = parseFloat(valorInput.replace(/[R$\s.]/g, '').replace(',', '.'));
                        
                        if (isNaN(valorBruto) || valorBruto <= 0) {
                            showNotification('‚ùå Valor da venda inv√°lido', 'error');
                            return;
                        }
                        
                        const vendaData = {
                            clienteId: parseInt(clienteId),
                            valorBruto: valorBruto,
                            status: status,
                            dataVenda: dataVenda || new Date().toISOString().split('T')[0],
                            observacao: observacao || ''
                        };
                        
                        // Adicionar cupom se selecionado
                        if (cupomCodigo && cupomCodigo.trim() !== '') {
                            vendaData.cupomCodigo = cupomCodigo.trim();
                        }
                        
                        console.log('üíæ Atualizando venda:', vendaData);
                        
                        // Enviar para API
                        const response = await fetch(`${API_BASE_URL}/vendas/${vendaId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(vendaData)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.text();
                            throw new Error(errorData || 'Erro ao atualizar venda');
                        }
                        
                        const result = await response.json();
                        console.log('‚úÖ Venda atualizada:', result);
                        
                        showNotification('‚úÖ Venda atualizada com sucesso!', 'success');
                        
                        // Fechar modal e recarregar dados
                        closeEditModal();
                        await loadVendasData();
                        await loadMetricas();
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao atualizar venda:', error);
                        showNotification('‚ùå Erro ao atualizar venda: ' + error.message, 'error');
                    }
                });
            }
        });

        // Fechar modal clicando fora dele
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('edit-venda-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeEditModal();
                    }
                });
            }
        });

        // Fun√ß√£o para formatar valor como moeda
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(value);
        }

        // Fun√ß√£o para toggle do menu do usu√°rio
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        // Fechar dropdown quando cliccar fora
        document.addEventListener('click', function(event) {
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userMenuBtn && userDropdown && !userMenuBtn.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.style.display = 'none';
            }
        });
        
        // Carregar dados do usu√°rio
        function loadUserData() {
            try {
                const userData = localStorage.getItem('maiconsoft_user') || localStorage.getItem('userData');
                if (userData) {
                    const user = JSON.parse(userData);
                    const userName = user.nome || user.name || 'Usu√°rio';
                    
                    const userNameEl = document.getElementById('userName');
                    const userNameDisplayEl = document.getElementById('userNameDisplay');
                    const userRoleDisplayEl = document.getElementById('userRoleDisplay');
                    
                    // Mostrar apenas o primeiro nome no bot√£o
                    if (userNameEl) userNameEl.textContent = userName.split(' ')[0]; // Primeiro nome
                    if (userNameDisplayEl) userNameDisplayEl.textContent = userName;
                    if (userRoleDisplayEl) userRoleDisplayEl.textContent = getRoleDisplayName(user.tipoUsuario || user.role);
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usu√°rio:', error);
            }
        }
        
        // Fun√ß√£o para obter nome do cargo
        function getRoleDisplayName(role) {
            const roles = {
                'FUNCIONARIO': 'Funcion√°rio',
                'VENDEDOR': 'Vendedor',
                'SUPERVISOR': 'Supervisor',
                'GERENTE': 'Gerente',
                'DIRETOR': 'Diretor',
                'ADMIN': 'Administrador'
            };
            return roles[role] || role || 'Funcion√°rio';
        }

        // Format currency input
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            
            const valorInput = document.getElementById('valor-venda');
            if (valorInput) {
                valorInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 0) {
                        value = (value / 100).toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        });
                        e.target.value = value;
                    }
                });
            }
        });
    </script>
</body>
</html>