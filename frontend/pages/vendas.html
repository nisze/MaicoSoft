<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendas - Maiconsoft</title>
    
    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Ícones Material Design -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/navigation.css">
    <link rel="stylesheet" href="../css/notifications.css">
    
    <style>
        /* Estilos para autocomplete */
        .suggestion-item:hover {
            background-color: #f9fafb !important;
        }
        
        .suggestion-item {
            transition: background-color 0.2s ease;
        }
        
        /* Animação de loading para sugestões */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .suggestions-loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* CSS para forçar posicionamento correto do modal */
        #edit-venda-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 9999 !important;
            background: rgba(0, 0, 0, 0.7) !important;
            overflow-y: auto !important;
        }

        #edit-venda-modal > div {
            background: white !important;
            margin: 2rem auto !important;
            max-width: 800px !important;
            border-radius: 12px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
            position: relative !important;
            max-height: calc(100vh - 4rem) !important;
            display: flex !important;
            flex-direction: column !important;
        }

        #edit-venda-modal .modal-footer {
            padding: 1.5rem !important;
            background: #f9fafb !important;
            display: flex !important;
            justify-content: flex-end !important;
            align-items: center !important;
            gap: 1rem !important;
            border-top: 1px solid #e5e7eb !important;
            flex-shrink: 0 !important;
            position: relative !important;
            bottom: auto !important;
            left: auto !important;
            right: auto !important;
            width: auto !important;
        }
    </style>
</head>
<body>

    <!-- Navigation Bar -->
    <nav style="background: #000000; padding: 1rem 0; box-shadow: 0 2px 20px rgba(0, 0, 0, 0.8); border-bottom: 2px solid #f59e0b;">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 2rem;">
            <div style="display: flex; align-items: center;">
                <a href="dashboard.html" style="text-decoration: none;">
                    <img src="../images/teste.webp" alt="Maiconsoft" style="height: 40px; width: auto;">
                </a>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <a href="dashboard.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">dashboard</span>
                    Dashboard
                </a>
                <a href="clientes.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">people</span>
                    Clientes
                </a>
                <a href="vendas.html" style="color: #000000; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; background: #f59e0b; font-weight: 600; border-radius: 6px;">
                    <span class="material-icons" style="font-size: 1.1rem;">trending_up</span>
                    Vendas
                </a>
                <a href="cupons.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">local_offer</span>
                    Cupons
                </a>
                <a href="usuarios.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">group</span>
                    Usuários
                </a>
                <a href="relatorios.html" style="color: #ffffff; text-decoration: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.3s; border-radius: 6px;" onmouseover="this.style.background='#333333'" onmouseout="this.style.background='transparent'">
                    <span class="material-icons" style="font-size: 1.1rem;">assessment</span>
                    Relatórios
                </a>
                
                <!-- Menu do Usuário -->
                <div style="position: relative; display: inline-block;">
                    <button id="userMenuBtn" onclick="toggleUserMenu()" style="background: #333333; color: #ffffff; border: none; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; cursor: pointer; border-radius: 6px; transition: all 0.3s;" onmouseover="this.style.background='#444444'" onmouseout="this.style.background='#333333'">
                        <!-- Avatar circular -->
                        <div style="position: relative; width: 28px; height: 28px; border-radius: 50%; overflow: hidden; border: 2px solid #ffffff; background: #4b5563; display: flex; align-items: center; justify-content: center;">
                            <img id="userAvatarImage" src="" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                            <div id="userAvatarPlaceholder" style="color: #ffffff; font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; justify-content: center;">U</div>
                        </div>
                        <span id="userName">Usuário</span>
                        <span class="material-icons" style="font-size: 1rem;">arrow_drop_down</span>
                    </button>
                    
                    <div id="userDropdown" style="display: none; position: absolute; right: 0; top: 100%; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border-radius: 8px; min-width: 200px; z-index: 1000; border: 1px solid #e5e7eb; margin-top: 0.5rem;">
                        <div style="padding: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;" id="userNameDisplay">Nome do Usuário</div>
                            <div style="font-size: 0.8rem; color: #6b7280;" id="userRoleDisplay">Cargo</div>
                        </div>
                        
                        <a href="perfil.html" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #374151; text-decoration: none; transition: all 0.3s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                            <span class="material-icons" style="font-size: 1.1rem; color: #3b82f6;">person</span>
                            Meu Perfil
                        </a>
                        
                        <a href="perfil.html#configuracoes" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #374151; text-decoration: none; transition: all 0.3s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='transparent'">
                            <span class="material-icons" style="font-size: 1.1rem; color: #6b7280;">settings</span>
                            Configurações
                        </a>
                        
                        <div style="border-top: 1px solid #e5e7eb; margin: 0.5rem 0;"></div>
                        
                        <a href="#" onclick="fazerLogout()" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: #ef4444; text-decoration: none; transition: all 0.3s;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='transparent'">
                            <span class="material-icons" style="font-size: 1.1rem;">logout</span>
                            Sair do Sistema
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Container Principal -->
    <div style="max-width: 1200px; margin: 0 auto; padding: 2rem; background: #f8fafc; min-height: calc(100vh - 70px);">
        
        <!-- Header da Página -->
        <div style="background: white; padding: 1.5rem 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem; border-left: 4px solid #3b82f6;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h1 style="margin: 0 0 0.5rem 0; font-size: 1.75rem; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 0.75rem;">
                        <span class="material-icons" style="font-size: 1.75rem; color: #3b82f6;">trending_up</span>
                        Gestão de Vendas
                    </h1>
                    <p style="margin: 0; color: #6b7280; font-size: 0.95rem;">Controle completo de vendas, orçamentos e performance comercial</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="switchVendasTab('resumo')" id="tab-resumo-btn" style="background: #3b82f6; color: white; border: none; padding: 0.6rem 1.2rem; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1rem;">dashboard</span>
                        Resumo
                    </button>
                    <button onclick="switchVendasTab('nova')" id="tab-nova-btn" style="background: transparent; color: #6b7280; border: none; padding: 0.6rem 1.2rem; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1rem;">add_circle</span>
                        Nova Venda
                    </button>
                    <button onclick="switchVendasTab('lista')" id="tab-lista-btn" style="background: transparent; color: #6b7280; border: none; padding: 0.6rem 1.2rem; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1rem;">list</span>
                        Todas Vendas
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB: RESUMO DE VENDAS -->
        <div id="tab-resumo" class="vendas-tab-content" style="display: block;">
            <!-- Métricas Principais -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div style="background: white; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #10b981;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; font-size: 0.85rem; color: #6b7280; font-weight: 500;">Total de Vendas</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="total-vendas">...</h3>
                        </div>
                        <div style="background: #d1fae5; padding: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: #10b981; font-size: 1.5rem;">monetization_on</span>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #3b82f6;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; font-size: 0.85rem; color: #6b7280; font-weight: 500;">Vendas Este Mês</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="vendas-mes">...</h3>
                        </div>
                        <div style="background: #dbeafe; padding: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: #3b82f6; font-size: 1.5rem;">trending_up</span>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #f59e0b;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; font-size: 0.85rem; color: #6b7280; font-weight: 500;">Orçamentos Pendentes</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="orcamentos-pendentes">...</h3>
                        </div>
                        <div style="background: #fef3c7; padding: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: #f59e0b; font-size: 1.5rem;">pending</span>
                        </div>
                    </div>
                </div>

                <div style="background: white; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #8b5cf6;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <p style="margin: 0; font-size: 0.85rem; color: #6b7280; font-weight: 500;">Ticket Médio</p>
                            <h3 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="ticket-medio">...</h3>
                        </div>
                        <div style="background: #ede9fe; padding: 0.75rem; display: flex; align-items: center; justify-content: center;">
                            <span class="material-icons" style="color: #8b5cf6; font-size: 1.5rem;">analytics</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vendas Recentes -->
            <div style="background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1.2rem; color: #10b981;">receipt_long</span>
                        Vendas Recentes
                    </h3>
                </div>
                <div style="padding: 1.5rem;">
                    <div id="vendas-recentes" style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Dados carregados via JavaScript -->
                    </div>
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button onclick="switchVendasTab('lista')" style="background: #3b82f6; color: white; border: none; padding: 0.7rem 1.5rem; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 1rem;">list</span>
                            Ver Todas as Vendas
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: NOVA VENDA -->
        <div id="tab-nova" class="vendas-tab-content" style="display: none;">
            <div style="background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <form id="nova-venda-form" style="padding: 0;">
                    <!-- Dados da Venda -->
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                        <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 1.2rem; color: #3b82f6;">add_shopping_cart</span>
                            Informações da Venda
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div style="position: relative;">
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Cliente *</label>
                                <input type="text" 
                                       id="cliente-search" 
                                       placeholder="Digite o nome do cliente..." 
                                       autocomplete="off"
                                       required 
                                       style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem; background: white;">
                                <input type="hidden" id="cliente-id" name="clienteId">
                                
                                <!-- Lista de sugestões -->
                                <div id="cliente-suggestions" 
                                     style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Data da Venda</label>
                                <input type="date" id="data-venda" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem;">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Valor Total *</label>
                                <input type="text" id="valor-venda" required style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem;" placeholder="R$ 0,00">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Cupom de Desconto</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    <select id="cupom-desconto" name="cupom" style="flex: 1; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem; background: white;">
                                        <option value="">Nenhum cupom</option>
                                        <!-- Cupons carregados via JavaScript -->
                                    </select>
                                    <button type="button" onclick="recarregarCupons()" title="Atualizar lista de cupons" 
                                            style="background: #10b981; color: white; border: none; padding: 0.6rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; min-width: 40px; transition: all 0.2s ease;"
                                            onmouseover="this.style.background='#059669'" 
                                            onmouseout="this.style.background='#10b981'">
                                        <span class="material-icons" style="font-size: 1.1rem;">refresh</span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Forma de Pagamento</label>
                                <select id="forma-pagamento" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem; background: white;">
                                    <option value="">Selecionar</option>
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="cartao_debito">Cartão de Débito</option>
                                    <option value="cartao_credito">Cartão de Crédito</option>
                                    <option value="pix">PIX</option>
                                    <option value="transferencia">Transferência</option>
                                    <option value="boleto">Boleto</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem;">Descrição/Observações</label>
                            <textarea id="descricao-venda" rows="3" style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; font-size: 0.9rem; resize: vertical;" placeholder="Descreva os produtos/serviços vendidos e observações importantes"></textarea>
                        </div>

                        <!-- Upload de Comprovante -->
                        <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.4rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="font-size: 1rem; color: #3b82f6;">receipt</span>
                                Comprovante de Pagamento (Opcional)
                            </label>
                            <div style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: end;">
                                <div style="flex: 1;">
                                    <input type="file" 
                                           id="comprovante-venda" 
                                           accept=".jpg,.jpeg,.png,.pdf" 
                                           style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; background: white; cursor: pointer;">
                                </div>
                                <button type="button" 
                                        onclick="limparArquivoComprovante('comprovante-venda')" 
                                        style="background: #ef4444; color: white; border: none; padding: 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem; white-space: nowrap;" 
                                        title="Limpar arquivo selecionado">
                                    <span class="material-icons" style="font-size: 0.9rem;">clear</span>
                                    Limpar
                                </button>
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="font-size: 0.9rem;">info</span>
                                Anexe o comprovante para confirmar automaticamente a venda. Formatos: JPG, PNG ou PDF (máx. 5MB)
                            </div>
                        </div>
                    </div>

                    <!-- Botões de Ação -->
                    <div style="padding: 1.5rem; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <button type="button" onclick="limparFormularioVenda()" style="background: #ef4444; color: white; border: none; padding: 0.7rem 1.2rem; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 1rem;">clear</span>
                            Limpar
                        </button>
                        
                        <div style="display: flex; gap: 0.75rem;">
                            <button type="button" onclick="salvarRascunhoVenda()" style="background: #f59e0b; color: white; border: none; padding: 0.7rem 1.2rem; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="font-size: 1rem;">save</span>
                                Rascunho
                            </button>
                            <button type="submit" style="background: #10b981; color: white; border: none; padding: 0.7rem 1.5rem; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                <span class="material-icons" style="font-size: 1rem;">add_shopping_cart</span>
                                Registrar Venda
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- TAB: LISTA DE VENDAS -->
        <div id="tab-lista" class="vendas-tab-content" style="display: none;">
            <div style="background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <!-- Filtros e Busca -->
                <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h3 style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #374151;">Todas as Vendas</h3>
                        <div style="display: flex; gap: 1rem;">
                            <input type="text" id="search-vendas" placeholder="Buscar por cliente, valor..." style="padding: 0.6rem 1rem; border: 1px solid #d1d5db; font-size: 0.9rem; min-width: 250px;">
                        </div>
                    </div>
                </div>

                <!-- Tabela de Vendas -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead style="background: #f9fafb;">
                            <tr>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">ID</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Cliente</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Valor</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Status</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Comprovante</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Data</th>
                                <th style="padding: 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="sales-tbody">
                            <!-- Dados carregados via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição de Venda -->
    <div id="edit-venda-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; overflow-y: auto;">
        <div style="background: white; margin: 2rem auto; max-width: 800px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); position: relative; max-height: calc(100vh - 4rem); display: flex; flex-direction: column;">
            <!-- Header do Modal -->
            <div style="padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="material-icons" style="font-size: 1.3rem; color: #3b82f6;">edit</span>
                    Editar Venda
                </h3>
                <button onclick="closeEditModal()" style="background: none; border: none; cursor: pointer; padding: 0.5rem; color: #6b7280; transition: color 0.3s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#6b7280'">
                    <span class="material-icons" style="font-size: 1.5rem;">close</span>
                </button>
            </div>

            <!-- Formulário de Edição -->
            <form id="edit-venda-form" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
                <!-- Dados da Venda -->
                <div style="padding: 2rem; flex: 1; overflow-y: auto;">
                    <h4 style="margin: 0 0 1.5rem 0; font-size: 1rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons" style="font-size: 1.1rem; color: #3b82f6;">shopping_cart</span>
                        Informações da Venda
                    </h4>
                    
                    <input type="hidden" id="edit-venda-id">
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="position: relative;">
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Cliente *</label>
                            <input type="text" 
                                   id="edit-cliente-search" 
                                   placeholder="Digite o nome do cliente..." 
                                   autocomplete="off"
                                   required 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white; transition: border-color 0.3s;">
                            <input type="hidden" id="edit-cliente-id" name="clienteId">
                            
                            <!-- Lista de sugestões -->
                            <div id="edit-cliente-suggestions" 
                                 style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #d1d5db; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Data da Venda</label>
                            <input type="date" id="edit-data-venda" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white;">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                <span id="edit-valor-label">Valor da Venda *</span>
                            </label>
                            <input type="text" id="edit-valor-venda" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white;" placeholder="R$ 0,00">
                            <!-- Informações de desconto e valor bruto -->
                            <div id="edit-valor-info" style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280; display: none;">
                                <div>Valor Bruto: <span id="edit-valor-bruto-info">R$ 0,00</span></div>
                                <div>Desconto: <span id="edit-valor-desconto">R$ 0,00</span></div>
                                <div style="font-weight: 600; color: #ef4444; font-size: 0.7rem;">Este valor não pode ser editado diretamente</div>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Forma de Pagamento</label>
                            <select id="edit-forma-pagamento" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white;">
                                <option value="">Selecionar</option>
                                <option value="dinheiro">Dinheiro</option>
                                <option value="cartao_debito">Cartão de Débito</option>
                                <option value="cartao_credito">Cartão de Crédito</option>
                                <option value="pix">PIX</option>
                                <option value="transferencia">Transferência</option>
                                <option value="boleto">Boleto</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Status</label>
                            <select id="edit-status-venda" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; background: white;">
                                <option value="PENDENTE">Pendente</option>
                                <option value="CONFIRMADA">Confirmada</option>
                                <option value="CANCELADA">Cancelada</option>
                                <option value="FINALIZADA">Finalizada</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label style="display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Descrição/Observações</label>
                        <textarea id="edit-descricao-venda" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; resize: vertical; background: white; font-family: inherit;" placeholder="Descreva os produtos/serviços vendidos e observações importantes"></textarea>
                    </div>

                    <!-- Seção de Comprovante -->
                    <div style="margin-top: 1.5rem; padding: 1.5rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <h5 style="margin: 0 0 1rem 0; font-size: 0.9rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 1rem; color: #3b82f6;">receipt</span>
                            Comprovante de Pagamento
                        </h5>
                        
                        <!-- Status atual do comprovante -->
                        <div id="comprovante-status" style="margin-bottom: 1rem; padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem;">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                        
                        <!-- Upload de novo comprovante -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; font-size: 0.8rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                                Anexar/Atualizar Comprovante
                            </label>
                            <div style="display: flex; gap: 0.5rem; align-items: end;">
                                <div style="flex: 1;">
                                    <input type="file" 
                                           id="edit-comprovante-venda" 
                                           accept=".jpg,.jpeg,.png,.pdf" 
                                           style="width: 100%; padding: 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem; background: white; cursor: pointer;">
                                </div>
                                <button type="button" 
                                        onclick="limparArquivoComprovante('edit-comprovante-venda')" 
                                        style="background: #ef4444; color: white; border: none; padding: 0.6rem; cursor: pointer; font-size: 0.75rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem; white-space: nowrap;" 
                                        title="Limpar arquivo selecionado">
                                    <span class="material-icons" style="font-size: 0.85rem;">clear</span>
                                    Limpar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Botões de ação para comprovante -->
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button type="button" 
                                    id="upload-comprovante-btn" 
                                    onclick="uploadComprovante()" 
                                    style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 0.4rem; border-radius: 4px; transition: background-color 0.3s;" 
                                    onmouseover="this.style.background='#2563eb'" 
                                    onmouseout="this.style.background='#3b82f6'">
                                <span class="material-icons" style="font-size: 0.9rem;">upload</span>
                                Enviar Comprovante
                            </button>
                            
                            <button type="button" 
                                    id="remove-comprovante-btn" 
                                    onclick="removerComprovante()" 
                                    style="background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.8rem; font-weight: 500; display: flex; align-items: center; gap: 0.4rem; border-radius: 4px; transition: background-color 0.3s; display: none;" 
                                    onmouseover="this.style.background='#dc2626'" 
                                    onmouseout="this.style.background='#ef4444'">
                                <span class="material-icons" style="font-size: 0.9rem;">delete</span>
                                Remover Comprovante
                            </button>
                        </div>
                        
                        <div style="margin-top: 0.75rem; font-size: 0.7rem; color: #6b7280; display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-icons" style="font-size: 0.8rem;">info</span>
                            Formatos aceitos: JPG, PNG ou PDF (máx. 5MB). O status da venda será atualizado automaticamente.
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="modal-footer" style="padding: 1.5rem 2rem; background: #f9fafb; display: flex; justify-content: flex-end; align-items: center; gap: 1rem; border-top: 1px solid #e5e7eb; flex-shrink: 0; border-radius: 0 0 12px 12px;">
                    <button type="button" onclick="closeEditModal()" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 0.9rem; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; border-radius: 6px; transition: background-color 0.3s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                        <span class="material-icons" style="font-size: 1rem;">cancel</span>
                        Cancelar
                    </button>
                    <button type="submit" style="background: #10b981; color: white; border: none; padding: 0.75rem 1.5rem; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; border-radius: 6px; transition: background-color 0.3s;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                        <span class="material-icons" style="font-size: 1rem;">save</span>
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Configuração da API
        const API_BASE_URL = window.API_BASE_URL || window.CONFIG?.API_BASE_URL || 'http://localhost:8090/api';
        
        // Função de notificação moderna
        function showNotification(message, type, duration = 3000) {
            // Criar notificação toast moderna
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10001;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                transform: translateX(400px);
                transition: transform 0.3s ease-out;
            `;
            
            // Adicionar ícone baseado no tipo
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            toast.textContent = `${icon} ${message}`;
            
            document.body.appendChild(toast);
            
            // Animar entrada
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // Remover após duração especificada
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Função de confirmação moderna
        function showConfirmation(message, title = 'Confirmação') {
            return new Promise((resolve) => {
                // Criar overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    animation: fadeIn 0.3s ease-out;
                `;
                
                // Criar modal de confirmação
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    border-radius: 16px;
                    padding: 2rem;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    animation: slideIn 0.4s ease-out;
                    max-width: 400px;
                    margin: 1rem;
                `;
                
                modal.innerHTML = `
                    <div style="color: #f59e0b; font-size: 3rem; margin-bottom: 1rem;">
                        <span class="material-icons" style="font-size: 3rem;">help_outline</span>
                    </div>
                    <h3 style="color: #1f2937; margin: 0 0 1rem 0; font-size: 1.3rem; font-weight: 600;">
                        ${title}
                    </h3>
                    <p style="color: #6b7280; margin: 0 0 2rem 0; font-size: 1rem; line-height: 1.5;">
                        ${message}
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button id="confirmCancel" style="background: #6b7280; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.3s;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                            Cancelar
                        </button>
                        <button id="confirmOk" style="background: #ef4444; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; transition: background 0.3s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'">
                            Confirmar
                        </button>
                    </div>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                // Adicionar animações CSS
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes slideIn {
                        from { transform: scale(0.8) translateY(-20px); opacity: 0; }
                        to { transform: scale(1) translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
                
                // Event listeners
                document.getElementById('confirmOk').addEventListener('click', () => {
                    overlay.remove();
                    style.remove();
                    resolve(true);
                });
                
                document.getElementById('confirmCancel').addEventListener('click', () => {
                    overlay.remove();
                    style.remove();
                    resolve(false);
                });
                
                // Fechar com ESC
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        overlay.remove();
                        style.remove();
                        document.removeEventListener('keydown', escHandler);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', escHandler);
            });
        }
        
        // Função para alternar entre tabs de vendas
        function switchVendasTab(tabName) {
            console.log('switchVendasTab chamado com:', tabName);
            
            // Ocultar todas as tabs
            const tabs = document.querySelectorAll('.vendas-tab-content');
            tabs.forEach(tab => tab.style.display = 'none');
            
            // Remover estilo ativo dos botões
            const buttons = ['tab-resumo-btn', 'tab-nova-btn', 'tab-lista-btn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.background = 'transparent';
                    btn.style.color = '#6b7280';
                }
            });
            
            // Mostrar tab selecionada e ativar botão
            const activeTab = document.getElementById(`tab-${tabName}`);
            const activeBtn = document.getElementById(`tab-${tabName}-btn`);
            
            if (activeTab && activeBtn) {
                activeTab.style.display = 'block';
                activeBtn.style.background = '#3b82f6';
                activeBtn.style.color = 'white';
            }
        }

        // Disponibilizar função globalmente
        window.switchVendasTab = switchVendasTab;

        // Função de logout com notificação moderna
        function fazerLogout() {
            // Mostrar notificação de logout
            showLogoutNotification();
            
            // Executar logout após 1.5 segundos
            setTimeout(() => {
                localStorage.removeItem('usuarioLogado');
                window.location.href = 'login.html';
            }, 1500);
        }
        
        function showLogoutNotification() {
            // Criar overlay de logout
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            // Criar card de logout
            const logoutCard = document.createElement('div');
            logoutCard.style.cssText = `
                background: #1a1a1a;
                border: 2px solid #f59e0b;
                border-radius: 16px;
                padding: 2rem;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                animation: slideIn 0.4s ease-out;
                max-width: 350px;
            `;
            
            logoutCard.innerHTML = `
                <div style="color: #f59e0b; font-size: 3rem; margin-bottom: 1rem;">
                    <span class="material-icons" style="font-size: 3rem;">logout</span>
                </div>
                <h3 style="color: white; margin: 0 0 0.5rem 0; font-size: 1.3rem; font-weight: 600;">
                    Saindo do sistema...
                </h3>
                <p style="color: #cccccc; margin: 0 0 1.5rem 0; font-size: 0.9rem;">
                    Obrigado por usar o Sistema Maiconsoft!
                </p>
                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: #f59e0b;">
                    <div class="loading-spinner"></div>
                    <span style="font-size: 0.85rem; font-weight: 500;">Redirecionando...</span>
                </div>
            `;
            
            overlay.appendChild(logoutCard);
            document.body.appendChild(overlay);
            
            // Adicionar estilos de animação
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                
                @keyframes slideIn {
                    from { transform: scale(0.8) translateY(-20px); opacity: 0; }
                    to { transform: scale(1) translateY(0); opacity: 1; }
                }
                
                .loading-spinner {
                    width: 16px;
                    height: 16px;
                    border: 2px solid #333;
                    border-top: 2px solid #f59e0b;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                }
                
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        }

        // Check authentication and permissions
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar se usuário está logado
            const usuarioLogado = localStorage.getItem('usuarioLogado');
            if (!usuarioLogado) {
                window.location.href = 'login.html';
                return;
            }
            
            const usuario = JSON.parse(usuarioLogado);
            console.log('Usuário logado:', usuario);
            
            // Atualizar informações do usuário na navbar
            updateUserInfo(usuario);
            
            // Liberar acesso para todos os usuários logados
            // Comentado para evitar erros - AppState não existe
            // const user = AppState.user;
            // const userRole = user?.perfil?.toLowerCase();
            
            // Configurar data padrão para hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('data-venda').value = hoje;
            
            loadVendasData();
            
            // Wait for APIService to be loaded
            if (window.APIService) {
                setupClienteAutocomplete();
                loadCuponsDisponiveis();
            } else {
                console.warn('⚠️ APIService não carregado ainda, tentando novamente...');
                setTimeout(() => {
                    if (window.APIService) {
                        setupClienteAutocomplete();
                        loadCuponsDisponiveis();
                    } else {
                        console.error('❌ APIService não pôde ser carregado');
                    }
                }, 100);
            }
            
            loadMetricas();
            
            // Configurar busca em tempo real para vendas
            setupSearchListeners();
            
            // Setup valor formatting
            const valorInput = document.getElementById('valor-venda');
            if (valorInput) {
                valorInput.addEventListener('input', function() {
                    let value = this.value.replace(/[^\d,]/g, '');
                    if (value) {
                        // Add R$ prefix if not empty
                        this.value = 'R$ ' + value;
                    }
                });
                
                valorInput.addEventListener('blur', function() {
                    let value = this.value.replace(/[^\d,]/g, '');
                    if (value && !value.includes(',')) {
                        // Add ,00 if no decimal part
                        this.value = 'R$ ' + value + ',00';
                    }
                });
            }
        });

        
        async function loadMetricas() {
            try {
                console.log('📊 Carregando métricas de vendas...');
                
                // Mostrar indicadores de carregamento
                showLoadingIndicators();
                
                // Buscar métricas da API de dashboard
                const response = await fetch(`${API_BASE_URL}/dashboard/metrics?days=30`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar métricas');
                }
                
                const data = await response.json();
                console.log('📈 Métricas carregadas:', data);
                
                // Buscar dados de vendas diretamente da API para calcular orçamentos pendentes
                const vendasResponse = await fetch(`${API_BASE_URL}/vendas?page=0&size=100`);
                let orcamentosPendentes = 0;
                
                if (vendasResponse.ok) {
                    const vendasData = await vendasResponse.json();
                    const vendas = vendasData.vendas || vendasData.content || [];
                    orcamentosPendentes = vendas.filter(venda => (venda.status || venda.statusVenda) === 'PENDENTE').length;
                } else {
                    console.warn('Erro ao buscar vendas para orçamentos pendentes');
                }
                
                // Atualizar interface com dados reais
                document.getElementById('total-vendas').textContent = `R$ ${parseFloat(data.totalRevenue || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('vendas-mes').textContent = (data.salesThisPeriod || 0).toString();
                document.getElementById('orcamentos-pendentes').textContent = orcamentosPendentes.toString();
                document.getElementById('ticket-medio').textContent = `R$ ${parseFloat(data.averageTicket || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                
                console.log('✅ Métricas atualizadas com dados reais do dashboard');
                
            } catch (error) {
                console.error('❌ Erro ao carregar métricas:', error);
                showNotification('Erro ao carregar métricas', 'error');
                
                // Fallback para valores padrão em caso de erro
                document.getElementById('total-vendas').textContent = 'R$ 0,00';
                document.getElementById('vendas-mes').textContent = '0';
                document.getElementById('orcamentos-pendentes').textContent = '0';
                document.getElementById('ticket-medio').textContent = 'R$ 0,00';
            }
        }
        
        // Função para mostrar indicadores de carregamento
        function showLoadingIndicators() {
            document.getElementById('total-vendas').textContent = '...';
            document.getElementById('vendas-mes').textContent = '...';
            document.getElementById('orcamentos-pendentes').textContent = '...';
            document.getElementById('ticket-medio').textContent = '...';
        }
        
        async function loadVendasData() {
            try {
                console.log('📋 Carregando dados de vendas...');
                
                // Mostrar indicadores de carregamento para vendas recentes
                let recentSales = document.getElementById('vendas-recentes');
                if (recentSales) {
                    recentSales.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Carregando vendas...</p>';
                }
                
                let allSales = document.getElementById('sales-tbody');
                if (allSales) {
                    allSales.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">
                                Carregando vendas...
                            </td>
                        </tr>
                    `;
                }
                
                // Buscar vendas reais da API usando fetch direto
                const response = await fetch(`${API_BASE_URL}/vendas?page=0&size=20`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const vendas = data.vendas || data.content || [];
                
                console.log('📊 Vendas carregadas:', vendas.length, vendas);
                
                // Mapear dados para o formato esperado pelo frontend
                const vendasFormatadas = vendas.map(venda => ({
                    id: venda.idVenda || venda.id,
                    cliente: venda.clienteNome || venda.cliente?.nome || 'Cliente não informado',
                    valor: venda.valorTotal || venda.valorVenda || 0,
                    status: getStatusPortugues(venda.status || venda.statusVenda),
                    data: venda.dataVenda || venda.datahoraCadastro || new Date().toISOString(),
                    descricao: venda.observacao || venda.descricao || 'Sem descrição',
                    numeroOrcamento: venda.numeroOrcamento || `#${String(venda.idVenda || venda.id).padStart(4, '0')}`,
                    comprovanteAnexado: venda.comprovanteAnexado || false,
                    comprovantePath: venda.comprovantePath || null,
                    comprovanteUploadDate: venda.comprovanteUploadDate || null
                }));
                
                // Load recent sales (resumo)
                recentSales = document.getElementById('vendas-recentes');
                if (recentSales) {
                    if (vendasFormatadas.length === 0) {
                        recentSales.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 2rem;">Nenhuma venda encontrada</p>';
                    } else {
                        recentSales.innerHTML = vendasFormatadas.slice(0, 5).map(venda => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border: 1px solid #e5e7eb; background: #f9fafb;">
                                <div>
                                    <p style="margin: 0; font-weight: 600; color: #1f2937; font-size: 0.9rem;">${venda.cliente}</p>
                                    <p style="margin: 0.25rem 0 0 0; color: #6b7280; font-size: 0.8rem;">${venda.descricao}</p>
                                    <p style="margin: 0.25rem 0 0 0; color: #9ca3af; font-size: 0.75rem;">${venda.numeroOrcamento}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="margin: 0; font-weight: 700; color: #10b981; font-size: 0.95rem;">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                                    <span style="font-size: 0.75rem; padding: 0.25rem 0.5rem; background: ${getStatusColor(venda.status)}; color: white; font-weight: 500;">${venda.status}</span>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                // Load all sales (lista)
                allSales = document.getElementById('sales-tbody');
                if (allSales) {
                    if (vendasFormatadas.length === 0) {
                        allSales.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                                        <span class="material-icons" style="font-size: 3rem; color: #d1d5db;">receipt_long</span>
                                        <p style="margin: 0; font-size: 1.1rem;">Nenhuma venda encontrada</p>
                                        <p style="margin: 0; font-size: 0.9rem; color: #9ca3af;">Clique em "Nova Venda" para registrar a primeira venda</p>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        allSales.innerHTML = vendasFormatadas.map(venda => `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 0.75rem; font-weight: 600; color: #1f2937;">${venda.numeroOrcamento}</td>
                                <td style="padding: 0.75rem; color: #374151;">${venda.cliente}</td>
                                <td style="padding: 0.75rem; font-weight: 600; color: #10b981;">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                <td style="padding: 0.75rem;">
                                    <span style="font-size: 0.8rem; padding: 0.3rem 0.6rem; border-radius: 4px; background: ${getStatusColor(venda.status)}; color: white; font-weight: 500;">
                                        ${venda.status}
                                    </span>
                                </td>
                                <td style="padding: 0.75rem;">
                                    ${venda.comprovanteAnexado ? 
                                        `<div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span class="material-icons" style="font-size: 1rem; color: #10b981;">check_circle</span>
                                            <span style="font-size: 0.8rem; color: #10b981; font-weight: 500;">Anexado</span>
                                        </div>` : 
                                        `<div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span class="material-icons" style="font-size: 1rem; color: #f59e0b;">pending</span>
                                            <span style="font-size: 0.8rem; color: #f59e0b; font-weight: 500;">Pendente</span>
                                        </div>`
                                    }
                                </td>
                                <td style="padding: 0.75rem; color: #6b7280; font-size: 0.9rem;">${formatarData(venda.data)}</td>
                                <td style="padding: 0.75rem;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        ${venda.comprovantePath ? 
                                            `<button onclick="visualizarComprovante('${venda.comprovantePath}')" style="background: #10b981; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Ver comprovante">
                                                <span class="material-icons" style="font-size: 0.9rem;">visibility</span>
                                            </button>
                                            <button onclick="removerComprovante(${venda.id})" style="background: #f59e0b; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Remover comprovante">
                                                <span class="material-icons" style="font-size: 0.9rem;">delete_forever</span>
                                            </button>` : 
                                            `<button onclick="enviarComprovante(${venda.id})" style="background: #f59e0b; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Enviar comprovante">
                                                <span class="material-icons" style="font-size: 0.9rem;">upload</span>
                                                <span style="font-size: 0.8rem;">Enviar</span>
                                            </button>`
                                        }
                                        <button onclick="editVenda(${venda.id})" style="background: #3b82f6; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Editar">
                                            <span class="material-icons" style="font-size: 0.9rem;">edit</span>
                                        </button>
                                        <button onclick="deleteVenda(${venda.id})" style="background: #ef4444; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Excluir">
                                            <span class="material-icons" style="font-size: 0.9rem;">delete</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
                
                console.log('✅ Dados de vendas carregados e exibidos');
                
            } catch (error) {
                console.error('❌ Erro ao carregar dados de vendas:', error);
                
                // Atualizar interface com mensagem de erro
                const recentSales = document.getElementById('vendas-recentes');
                if (recentSales) {
                    recentSales.innerHTML = `
                        <div style="text-align: center; color: #ef4444; padding: 2rem;">
                            <span class="material-icons" style="font-size: 2rem; margin-bottom: 1rem;">error</span>
                            <p style="margin: 0;">Erro ao carregar vendas: ${error.message}</p>
                        </div>
                    `;
                }
                
                const allSales = document.getElementById('sales-tbody');
                if (allSales) {
                    allSales.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; color: #ef4444; padding: 2rem;">
                                Erro ao carregar vendas: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        // Array global para armazenar todas as vendas carregadas
        let todasAsVendas = [];
        
        // Configurar listeners para busca em tempo real
        function setupSearchListeners() {
            console.log('🔧 Configurando listeners de busca de vendas...');
            
            const searchInput = document.getElementById('search-vendas');
            
            if (searchInput) {
                // Busca em tempo real com debounce
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        console.log('🔍 Busca automática de vendas disparada');
                        filtrarVendas();
                    }, 500); // 500ms de delay
                });
                
                // Busca ao pressionar Enter
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        console.log('🔍 Busca de vendas por Enter');
                        filtrarVendas();
                    }
                });
                
                console.log('✅ Listeners do campo de busca de vendas configurados');
            }
        }
        
        // Função para filtrar vendas
        async function filtrarVendas() {
            const searchTerm = document.getElementById('search-vendas').value.toLowerCase().trim();
            
            console.log('🔍 Filtrando vendas com termo:', searchTerm || '(vazio)');
            
            // Se ainda não temos vendas carregadas, carregar primeiro
            if (todasAsVendas.length === 0) {
                try {
                    const response = await fetch(`${API_BASE_URL}/vendas?page=0&size=100`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    const vendas = data.vendas || data.content || [];
                    
                    todasAsVendas = vendas.map(venda => ({
                        id: venda.idVenda || venda.id,
                        cliente: venda.clienteNome || venda.cliente?.nome || 'Cliente não informado',
                        valor: venda.valorTotal || venda.valorVenda || 0,
                        status: getStatusPortugues(venda.status || venda.statusVenda),
                        data: venda.dataVenda || venda.datahoraCadastro || new Date().toISOString(),
                        descricao: venda.observacao || venda.descricao || 'Sem descrição',
                        numeroOrcamento: venda.numeroOrcamento || `#${String(venda.idVenda || venda.id).padStart(4, '0')}`,
                        comprovanteAnexado: venda.comprovanteAnexado || false,
                        comprovantePath: venda.comprovantePath || null,
                        comprovanteUploadDate: venda.comprovanteUploadDate || null
                    }));
                } catch (error) {
                    console.error('❌ Erro ao carregar vendas para filtro:', error);
                    showNotification('Erro ao carregar vendas para filtro', 'error');
                    return;
                }
            }
            
            // Se não há termo de busca, mostrar todas as vendas do cache
            let vendasParaMostrar = todasAsVendas;
            
            if (searchTerm) {
                // Filtrar vendas baseado no termo de busca
                vendasParaMostrar = todasAsVendas.filter(venda => {
                    return venda.cliente.toLowerCase().includes(searchTerm) ||
                           venda.valor.toString().includes(searchTerm) ||
                           venda.numeroOrcamento.toLowerCase().includes(searchTerm) ||
                           venda.descricao.toLowerCase().includes(searchTerm) ||
                           venda.status.toLowerCase().includes(searchTerm);
                });
            }
            
            console.log('📊 Vendas para mostrar:', vendasParaMostrar.length, 'de', todasAsVendas.length);
            
            // Atualizar tabela com vendas filtradas
            const allSales = document.getElementById('sales-tbody');
            if (allSales) {
                if (vendasParaMostrar.length === 0) {
                    const mensagem = searchTerm ? 'Nenhuma venda encontrada' : 'Nenhuma venda cadastrada';
                    const submensagem = searchTerm ? 'Tente usar outros termos de busca' : 'Comece cadastrando uma nova venda';
                    const botao = searchTerm ? 
                        `<button onclick="limparFiltroVendas()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; border-radius: 6px; font-size: 0.9rem;">
                            Limpar Filtro
                        </button>` : '';
                    
                    allSales.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; color: #6b7280; padding: 2rem;">
                                <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                                    <span class="material-icons" style="font-size: 3rem; color: #d1d5db;">${searchTerm ? 'search_off' : 'shopping_cart'}</span>
                                    <p style="margin: 0; font-size: 1.1rem;">${mensagem}</p>
                                    <p style="margin: 0; font-size: 0.9rem; color: #9ca3af;">${submensagem}</p>
                                    ${botao}
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    allSales.innerHTML = vendasParaMostrar.map(venda => `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                            <td style="padding: 0.75rem; font-weight: 600; color: #1f2937;">${venda.numeroOrcamento}</td>
                            <td style="padding: 0.75rem; color: #374151;">${venda.cliente}</td>
                            <td style="padding: 0.75rem; font-weight: 600; color: #10b981;">R$ ${venda.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td style="padding: 0.75rem;">
                                <span style="font-size: 0.8rem; padding: 0.3rem 0.6rem; border-radius: 4px; background: ${getStatusColor(venda.status)}; color: white; font-weight: 500;">
                                    ${venda.status}
                                </span>
                            </td>
                            <td style="padding: 0.75rem;">
                                ${venda.comprovanteAnexado ? 
                                    `<div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="material-icons" style="font-size: 1rem; color: #10b981;">check_circle</span>
                                        <span style="font-size: 0.8rem; color: #10b981; font-weight: 500;">Anexado</span>
                                    </div>` : 
                                    `<div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span class="material-icons" style="font-size: 1rem; color: #f59e0b;">pending</span>
                                        <span style="font-size: 0.8rem; color: #f59e0b; font-weight: 500;">Pendente</span>
                                    </div>`
                                }
                            </td>
                            <td style="padding: 0.75rem; color: #6b7280; font-size: 0.9rem;">${formatarData(venda.data)}</td>
                            <td style="padding: 0.75rem;">
                                <div style="display: flex; gap: 0.5rem;">
                                    ${venda.comprovantePath ? 
                                        `<button onclick="visualizarComprovante('${venda.comprovantePath}')" style="background: #10b981; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Ver comprovante">
                                            <span class="material-icons" style="font-size: 0.9rem;">visibility</span>
                                        </button>
                                        <button onclick="removerComprovante(${venda.id})" style="background: #f59e0b; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Remover comprovante">
                                            <span class="material-icons" style="font-size: 0.9rem;">delete_forever</span>
                                        </button>` : 
                                        `<button onclick="enviarComprovante(${venda.id})" style="background: #f59e0b; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Enviar comprovante">
                                            <span class="material-icons" style="font-size: 0.9rem;">upload</span>
                                            <span style="font-size: 0.8rem;">Enviar</span>
                                        </button>`
                                    }
                                    <button onclick="editVenda(${venda.id})" style="background: #3b82f6; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Editar">
                                        <span class="material-icons" style="font-size: 0.9rem;">edit</span>
                                    </button>
                                    <button onclick="deleteVenda(${venda.id})" style="background: #ef4444; color: white; border: none; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 0.8rem; border-radius: 4px; display: flex; align-items: center; gap: 0.3rem;" title="Excluir">
                                        <span class="material-icons" style="font-size: 0.9rem;">delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }
        
        // Função para limpar filtro de vendas
        function limparFiltroVendas() {
            document.getElementById('search-vendas').value = '';
            loadVendasData();
        }
        
        // Função para formatar data
        function formatarData(dataString) {
            if (!dataString) return 'Data não informada';
            
            try {
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR');
            } catch (error) {
                console.warn('Erro ao formatar data:', dataString);
                return 'Data inválida';
            }
        }
        
        // Função para deletar venda
        async function deleteVenda(id) {
            const confirmed = await showConfirmation(
                'Esta ação não pode ser desfeita.',
                'Tem certeza que deseja excluir esta venda?'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                console.log('🗑️ Excluindo venda:', id);
                
                const response = await fetch(`${API_BASE_URL}/vendas/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(errorData || 'Erro ao excluir venda');
                }
                
                showNotification('✅ Venda excluída com sucesso!', 'success');
                
                // Recarregar dados
                await loadVendasData();
                await loadMetricas();
                
            } catch (error) {
                console.error('❌ Erro ao excluir venda:', error);
                showNotification('❌ Erro ao excluir venda: ' + error.message, 'error');
            }
        }
        
        // Função auxiliar para converter status do backend para português
        function getStatusPortugues(status) {
            const statusMap = {
                'PENDENTE': 'Pendente',
                'CONFIRMADA': 'Confirmada',
                'CANCELADA': 'Cancelada',
                'FINALIZADA': 'Finalizada'
            };
            return statusMap[status] || status || 'Indefinido';
        }
        
        function getStatusColor(status) {
            switch(status?.toUpperCase()) {
                case 'FINALIZADA':
                    return '#10b981';
                case 'CONFIRMADA': 
                    return '#3b82f6';
                case 'PENDENTE': 
                    return '#f59e0b';
                case 'CANCELADA':
                    return '#ef4444';
                default: 
                    return '#6b7280';
            }
        }
        
        // Configurar autocomplete para clientes
        function setupClienteAutocomplete() {
            setupAutocompleteField('cliente-search', 'cliente-id', 'cliente-suggestions');
            setupAutocompleteField('edit-cliente-search', 'edit-cliente-id', 'edit-cliente-suggestions');
        }

        function setupAutocompleteField(inputId, hiddenId, suggestionsId) {
            const input = document.getElementById(inputId);
            const hiddenInput = document.getElementById(hiddenId);
            const suggestions = document.getElementById(suggestionsId);
            
            if (!input || !hiddenInput || !suggestions) return;
            
            // Check if APIService is loaded
            if (!window.APIService) {
                console.error('❌ APIService não está carregado para', inputId);
                return;
            }

            let searchTimeout;
            let selectedIndex = -1;

            // Buscar clientes enquanto digita
            input.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                
                // Reset visual state when user starts typing
                this.style.borderColor = '#d1d5db';
                this.style.backgroundColor = 'white';
                hiddenInput.value = '';
                
                clearTimeout(searchTimeout);
                
                if (searchTerm.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }

                searchTimeout = setTimeout(async () => {
                    await searchClientes(searchTerm, suggestions, input, hiddenInput);
                }, 300);
            });

            // Navegação com teclado
            input.addEventListener('keydown', function(e) {
                const items = suggestions.querySelectorAll('.suggestion-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items, selectedIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items, selectedIndex);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        selectCliente(items[selectedIndex], input, hiddenInput, suggestions);
                    }
                } else if (e.key === 'Escape') {
                    suggestions.style.display = 'none';
                    selectedIndex = -1;
                }
            });

            // Ocultar sugestões ao clicar fora
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                    selectedIndex = -1;
                }
            });
        }

        async function searchClientes(searchTerm, suggestions, input, hiddenInput) {
            try {
                console.log('🔍 Buscando clientes:', searchTerm);
                
                // Debug APIService
                console.log('🔧 APIService:', window.APIService);
                console.log('🔧 APIService.clientes:', window.APIService?.clientes);
                console.log('🔧 APIService.clientes.search:', window.APIService?.clientes?.search);
                
                if (!window.APIService || !window.APIService.clientes || !window.APIService.clientes.search) {
                    throw new Error('APIService não está carregado corretamente');
                }
                
                const response = await APIService.clientes.search(searchTerm, 0, 10);
                const clientes = response.content || response.clientes || [];
                
                if (clientes.length === 0) {
                    suggestions.innerHTML = '<div style="padding: 0.75rem; color: #6b7280; font-style: italic;">Nenhum cliente encontrado</div>';
                } else {
                    suggestions.innerHTML = clientes.map(cliente => {
                        const clienteId = cliente.idCliente || cliente.id;
                        const clienteNome = cliente.razaoSocial || cliente.nomeFantasia || cliente.nome || 'Cliente sem nome';
                        const clienteCodigo = cliente.codigo || '';
                        const clienteCpfCnpj = cliente.cpfCnpj || '';
                        const clienteEmail = cliente.email || '';
                        const clienteTelefone = cliente.telefone || '';
                        const clienteCidade = cliente.cidade || '';
                        
                        // Formatação do CPF/CNPJ para exibição
                        let cpfCnpjFormatado = '';
                        if (clienteCpfCnpj) {
                            if (clienteCpfCnpj.length === 11) {
                                // CPF: 000.000.000-00
                                cpfCnpjFormatado = clienteCpfCnpj.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                            } else if (clienteCpfCnpj.length === 14) {
                                // CNPJ: 00.000.000/0000-00
                                cpfCnpjFormatado = clienteCpfCnpj.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                            } else {
                                cpfCnpjFormatado = clienteCpfCnpj;
                            }
                        }
                        
                        return `
                            <div class="suggestion-item" 
                                 data-id="${clienteId}" 
                                 data-nome="${clienteNome}"
                                 style="padding: 0.75rem; cursor: pointer; border-bottom: 1px solid #f3f4f6; hover:background-color: #f9fafb;">
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                                    ${clienteNome}
                                    ${clienteCodigo ? `<span style="color: #6b7280; font-weight: 400; margin-left: 0.5rem;">(Cód: ${clienteCodigo})</span>` : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: #6b7280; line-height: 1.4;">
                                    ${cpfCnpjFormatado ? `🆔 ${cpfCnpjFormatado}` : ''}
                                    ${clienteEmail ? ` • 📧 ${clienteEmail}` : ''}
                                    ${clienteTelefone ? ` • 📞 ${clienteTelefone}` : ''}
                                    ${clienteCidade ? ` • 📍 ${clienteCidade}` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Adicionar eventos de clique
                    suggestions.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', () => {
                            selectCliente(item, input, hiddenInput, suggestions);
                        });
                        
                        item.addEventListener('mouseenter', () => {
                            updateSelection(suggestions.querySelectorAll('.suggestion-item'), Array.from(suggestions.querySelectorAll('.suggestion-item')).indexOf(item));
                        });
                    });
                }
                
                suggestions.style.display = 'block';
            } catch (error) {
                console.error('Erro ao buscar clientes:', error);
                suggestions.innerHTML = '<div style="padding: 0.75rem; color: #ef4444;">Erro ao buscar clientes</div>';
                suggestions.style.display = 'block';
            }
        }

        function selectCliente(item, input, hiddenInput, suggestions) {
            const clienteId = item.dataset.id;
            const clienteNome = item.dataset.nome;
            
            input.value = clienteNome;
            hiddenInput.value = clienteId;
            suggestions.style.display = 'none';
            
            // Adicionar indicação visual de que o cliente foi selecionado
            input.style.borderColor = '#10b981';
            input.style.backgroundColor = '#f0fdf4';
            
            console.log('✅ Cliente selecionado:', { id: clienteId, nome: clienteNome });
        }

        // Função para carregar cupons disponíveis
        async function loadCuponsDisponiveis() {
            try {
                console.log('📋 Carregando cupons disponíveis...');
                
                const cupomSelect = document.getElementById('cupom-desconto');
                if (cupomSelect) {
                    // Carregar cupons do backend
                    const API_BASE_URL = window.API_BASE_URL || window.CONFIG?.API_BASE_URL || 'http://localhost:8090/api';
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/cupons?page=0&size=100&sortBy=nome&sortDir=asc`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            const cupons = data.content || [];
                            
                            // Filtrar apenas cupons ativos e não expirados
                            const cuponsAtivos = cupons.filter(cupom => 
                                cupom.ativo && 
                                !cupom.expirado && 
                                !cupom.limiteEsgotado &&
                                cupom.status === 'ATIVO'
                            );
                            
                            // Limpar opções existentes (exceto "Nenhum cupom")
                            cupomSelect.innerHTML = '<option value="">Nenhum cupom</option>';
                            
                            // Adicionar cupons disponíveis do backend
                            cuponsAtivos.forEach(cupom => {
                                const option = document.createElement('option');
                                option.value = cupom.codigo;
                                
                                // Formatar desconto
                                let desconto = '';
                                if (cupom.descontoPercentual) {
                                    desconto = `${cupom.descontoPercentual}%`;
                                } else if (cupom.descontoValor) {
                                    desconto = `R$ ${cupom.descontoValor.toFixed(2)}`;
                                }
                                
                                // Adicionar informações adicionais
                                let info = '';
                                if (cupom.valorMinimo) {
                                    info += ` - Mín: R$ ${cupom.valorMinimo.toFixed(2)}`;
                                }
                                if (cupom.maxUsos && cupom.usosAtuais !== null) {
                                    const restantes = cupom.maxUsos - (cupom.usosAtuais || 0);
                                    info += ` - Restam: ${restantes}`;
                                }
                                
                                option.textContent = `${cupom.codigo} - ${cupom.nome} (${desconto})${info}`;
                                option.title = cupom.descricao || '';
                                cupomSelect.appendChild(option);
                            });
                            
                            console.log(`✅ ${cuponsAtivos.length} cupons ativos carregados do backend`);
                            
                        } else {
                            throw new Error(`Erro na API: ${response.status}`);
                        }
                        
                    } catch (apiError) {
                        console.warn('⚠️ API não disponível, usando cupons fixos:', apiError);
                        
                        // Fallback: cupons fixos se a API não estiver disponível
                        const cuponsFixos = [
                            { codigo: 'BEMVINDO10', nome: 'Boas-vindas', desconto: '10%' },
                            { codigo: 'FIDELIDADE15', nome: 'Cliente Fiel', desconto: '15%' },
                            { codigo: 'PROMO20', nome: 'Promoção Especial', desconto: '20%' }
                        ];
                        
                        // Limpar opções existentes (exceto "Nenhum cupom")
                        cupomSelect.innerHTML = '<option value="">Nenhum cupom</option>';
                        
                        // Adicionar cupons fixos
                        cuponsFixos.forEach(cupom => {
                            const option = document.createElement('option');
                            option.value = cupom.codigo;
                            option.textContent = `${cupom.codigo} - ${cupom.nome} (${cupom.desconto})`;
                            cupomSelect.appendChild(option);
                        });
                        
                        console.log(`✅ ${cuponsFixos.length} cupons fixos carregados (fallback)`);
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao carregar cupons:', error);
            }
        }

        // Função para recarregar cupons manualmente
        async function recarregarCupons() {
            const button = event?.target.closest('button');
            const icon = button?.querySelector('.material-icons');
            
            if (icon) {
                icon.style.animation = 'spin 1s linear infinite';
                button.disabled = true;
                button.style.opacity = '0.7';
            }
            
            try {
                await loadCuponsDisponiveis();
                
                // Mostrar feedback visual
                if (window.showNotification) {
                    showNotification('✅ Cupons atualizados!', 'success', 2000);
                } else {
                    console.log('✅ Cupons atualizados!');
                }
                
            } catch (error) {
                console.error('❌ Erro ao recarregar cupons:', error);
                if (window.showNotification) {
                    showNotification('❌ Erro ao atualizar cupons', 'error', 3000);
                }
            } finally {
                if (icon) {
                    setTimeout(() => {
                        icon.style.animation = '';
                        button.disabled = false;
                        button.style.opacity = '1';
                    }, 1000);
                }
            }
        }

        // Adicionar CSS para animação de rotação
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);

        function updateSelection(items, selectedIndex) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.style.backgroundColor = '#3b82f6';
                    item.style.color = 'white';
                } else {
                    item.style.backgroundColor = '';
                    item.style.color = '';
                }
            });
        }
        
        // Funções do formulário
        async function limparFormularioVenda() {
            const confirmed = await showConfirmation(
                'Todos os campos preenchidos serão perdidos.',
                'Tem certeza que deseja limpar todos os campos?'
            );
            
            if (confirmed) {
                document.getElementById('nova-venda-form').reset();
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('data-venda').value = hoje;
                localStorage.removeItem('rascunho_venda');
            }
        }
        
        function salvarRascunhoVenda() {
            const formData = new FormData(document.getElementById('nova-venda-form'));
            const data = Object.fromEntries(formData);
            localStorage.setItem('rascunho_venda', JSON.stringify(data));
            showNotification('✅ Rascunho da venda salvo com sucesso!', 'success');
        }
        
        // Submissão do formulário
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('nova-venda-form');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(this);
                    const vendaData = Object.fromEntries(formData);
                    
                    // Validar campos obrigatórios usando os novos campos
                    const clienteId = document.getElementById('cliente-id').value;
                    const clienteNome = document.getElementById('cliente-search').value;
                    const valorVenda = document.getElementById('valor-venda').value;
                    
                    console.log('🔍 Validação:', {
                        clienteId,
                        clienteNome,
                        valorVenda,
                        formData: vendaData
                    });
                    
                    if (!clienteId) {
                        showNotification('❌ Por favor, selecione um cliente válido da lista de sugestões!', 'error');
                        document.getElementById('cliente-search').focus();
                        return;
                    }
                    
                    if (!valorVenda || valorVenda.trim() === '') {
                        showNotification('❌ Por favor, preencha o valor total da venda!', 'error');
                        document.getElementById('valor-venda').focus();
                        return;
                    }
                    
                    const submitBtn = this.querySelector('[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="material-icons" style="font-size: 1rem;">hourglass_empty</span> Salvando...';
                    submitBtn.disabled = true;
                    
                    try {
                        console.log('📤 Enviando venda para API:', vendaData);
                        
                        // Limpar e processar o valor da venda
                        const valorLimpo = valorVenda.replace(/[R$\s\.]/g, '').replace(',', '.');
                        const valorNumerico = parseFloat(valorLimpo);
                        
                        if (isNaN(valorNumerico) || valorNumerico <= 0) {
                            showNotification('❌ Valor da venda inválido! Use formato: R$ 1.500,00', 'error');
                            document.getElementById('valor-venda').focus();
                            return;
                        }
                        
                        // Preparar dados para a API
                        const dataVenda = document.getElementById('data-venda').value;
                        const descricaoVenda = document.getElementById('descricao-venda').value;
                        const cupomCodigo = document.getElementById('cupom-desconto').value;
                        
                        const vendaPayload = {
                            clienteId: parseInt(clienteId),
                            valorBruto: valorNumerico,
                            status: 'PENDENTE', // Status será determinado pelo backend baseado no comprovante
                            dataVenda: dataVenda || new Date().toISOString().split('T')[0],
                            observacao: descricaoVenda || ''
                        };
                        
                        // Adicionar cupom se selecionado
                        if (cupomCodigo && cupomCodigo.trim() !== '') {
                            vendaPayload.cupomCodigo = cupomCodigo.trim();
                            console.log('🎫 Cupom selecionado:', cupomCodigo);
                        }
                        
                        console.log('📋 Payload preparado:', vendaPayload);
                        
                        // Criar venda via API
                        const response = await APIService.vendas.create(vendaPayload);
                        console.log('✅ Venda criada com sucesso:', response);
                        
                        // Processar upload de comprovante se houver arquivo selecionado
                        if (response.idVenda) {
                            await processComprovanteUpload(response.idVenda);
                        }
                        
                        localStorage.removeItem('rascunho_venda');
                        
                        // Mostrar mensagem de sucesso com número do orçamento
                        const numeroOrcamento = response.numeroOrcamento || `#${response.idVenda}`;
                        showNotification(`✅ Venda registrada com sucesso! Orçamento: ${numeroOrcamento}`, 'success');
                        
                        this.reset();
                        const hoje = new Date().toISOString().split('T')[0];
                        document.getElementById('data-venda').value = hoje;
                        
                        // Recarregar dados
                        await loadVendasData();
                        await loadMetricas();
                        
                    } catch (error) {
                        console.error('❌ Erro ao criar venda:', error);
                        
                        let errorMessage = 'Erro ao registrar venda. Tente novamente.';
                        if (error.message.includes('Cliente não encontrado')) {
                            errorMessage = 'Cliente selecionado não foi encontrado.';
                        } else if (error.message.includes('valor')) {
                            errorMessage = 'Valor da venda é inválido.';
                        }
                        
                        showNotification(`❌ ${errorMessage}`, 'error');
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }
        });

        // Handler do formulário de edição
        document.addEventListener('DOMContentLoaded', function() {
            const editForm = document.getElementById('edit-venda-form');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const submitBtn = this.querySelector('[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="material-icons" style="font-size: 1rem; animation: spin 1s linear infinite;">hourglass_empty</span> Salvando...';
                    submitBtn.disabled = true;
                    
                    try {
                        const formData = new FormData(this);
                        const vendaId = document.getElementById('edit-venda-id').value;
                        
                        // Obter clienteId do campo hidden
                        const clienteId = document.getElementById('edit-cliente-id').value;
                        if (!clienteId) {
                            showNotification('❌ Por favor, selecione um cliente!', 'error');
                            return;
                        }
                        
                        // Obter dados do formulário
                        const valorInput = document.getElementById('edit-valor-venda').value;
                        const valorEditavel = !document.getElementById('edit-valor-venda').readOnly;
                        
                        // Se o campo está editável, é valor bruto; se não, é valor final
                        let valorBruto;
                        if (valorEditavel) {
                            // Campo editável = valor bruto
                            valorBruto = parseFloat(valorInput.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                        } else {
                            // Campo não editável = valor final, usar valor bruto da venda original
                            valorBruto = currentEditingVendaData?.valorBruto || 0;
                        }

                        const vendaData = {
                            id: vendaId,
                            clienteId: parseInt(clienteId),
                            dataVenda: formData.get('edit-data-venda') || document.getElementById('edit-data-venda').value,
                            valorBruto: valorBruto,
                            status: formData.get('edit-status-venda') || document.getElementById('edit-status-venda').value,
                            observacao: formData.get('edit-descricao-venda') || document.getElementById('edit-descricao-venda').value,
                            // Incluir comprovantePath atual para manter informação de comprovante
                            comprovantePath: currentEditingVendaData?.comprovantePath || null,
                            cupomCodigo: currentEditingVendaData?.cupomCodigo || null // Preservar cupom existente
                        };
                        
                        console.log('💾 Atualizando venda:', vendaData);
                        
                        // Tentar atualizar via API
                        try {
                            const response = await apiClient.updateVenda(vendaId, vendaData);
                            console.log('✅ Venda atualizada via API:', response);
                            
                        } catch (apiError) {
                            console.log('⚠️ API indisponível, simulando sucesso:', apiError);
                            // Simular delay para parecer real
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                        
                        showNotification('✅ Venda atualizada com sucesso!', 'success');
                        
                        // Fechar modal
                        closeEditModal();
                        
                        // Recarregar dados
                        loadVendasData();
                        loadMetricas();
                        
                    } catch (error) {
                        console.error('❌ Erro ao atualizar venda:', error);
                        showNotification('❌ Erro ao atualizar venda. Tente novamente.', 'error');
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }
        });
        
        // Função para limpar arquivo de comprovante selecionado
        function limparArquivoComprovante(inputId) {
            const fileInput = document.getElementById(inputId);
            if (fileInput) {
                fileInput.value = '';
                console.log(`🗑️ Arquivo limpo do campo: ${inputId}`);
            }
        }

        // Função para atualizar informações de valor no modal de edição
        function updateEditValorInfo(venda) {
            const valorInfo = document.getElementById('edit-valor-info');
            const valorBrutoInfo = document.getElementById('edit-valor-bruto-info');
            const valorDesconto = document.getElementById('edit-valor-desconto');
            
            if (venda.valorDesconto && venda.valorDesconto > 0) {
                // Mostrar informações de desconto se houver
                valorInfo.style.display = 'block';
                valorBrutoInfo.textContent = `R$ ${venda.valorBruto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                valorDesconto.textContent = `R$ ${venda.valorDesconto.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            } else {
                // Esconder se não houver desconto
                valorInfo.style.display = 'none';
            }
        }

        // Função para fechar o modal de edição
        function closeEditModal() {
            document.getElementById('edit-venda-modal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Restaurar scroll do body
            currentEditingVendaId = null; // Limpar ID da venda sendo editada
            currentEditingVendaData = null; // Limpar dados da venda sendo editada
        }

        // Função para editar venda
        async function editVenda(id, focusComprovante = false) {
            try {
                console.log('✏️ Carregando venda para edição:', id);
                
                // Buscar dados da venda
                const response = await fetch(`${API_BASE_URL}/vendas/${id}`);
                
                if (!response.ok) {
                    throw new Error('Erro ao buscar venda');
                }
                
                const venda = await response.json();
                console.log('📊 Dados da venda carregados:', venda);
                
                // Definir ID e dados da venda sendo editada
                currentEditingVendaId = venda.idVenda || id;
                currentEditingVendaData = venda; // Armazenar dados completos
                
                // Preencher modal de edição
                document.getElementById('edit-venda-id').value = venda.idVenda;
                document.getElementById('edit-cliente-search').value = venda.clienteNome || '';
                document.getElementById('edit-cliente-id').value = venda.clienteId || '';
                
                // Lógica inteligente para mostrar valor: se há desconto, mostra valor final (read-only), senão valor bruto (editável)
                if (venda.valorDesconto && venda.valorDesconto > 0) {
                    // Há desconto: mostrar valor final e tornar campo não editável
                    document.getElementById('edit-valor-venda').value = formatCurrency(venda.valorTotal || 0);
                    document.getElementById('edit-valor-venda').readOnly = true;
                    document.getElementById('edit-valor-venda').style.backgroundColor = '#f3f4f6';
                    document.getElementById('edit-valor-label').textContent = 'Valor Final (com desconto) *';
                } else {
                    // Sem desconto: mostrar valor bruto e permitir edição
                    document.getElementById('edit-valor-venda').value = formatCurrency(venda.valorBruto || 0);
                    document.getElementById('edit-valor-venda').readOnly = false;
                    document.getElementById('edit-valor-venda').style.backgroundColor = 'white';
                    document.getElementById('edit-valor-label').textContent = 'Valor da Venda *';
                }
                
                document.getElementById('edit-status-venda').value = venda.status || 'PENDENTE';
                document.getElementById('edit-data-venda').value = venda.dataVenda || '';
                document.getElementById('edit-descricao-venda').value = venda.observacao || '';
                
                // Atualizar informações de valor (desconto e valor final)
                updateEditValorInfo(venda);
                
                // Atualizar status do comprovante
                await updateComprovanteStatus(venda);
                
                // Selecionar cupom se houver (campo não existe no modal de edição)
                // TODO: Adicionar campo de cupom no modal de edição se necessário
                
                // Mostrar modal e forçar posicionamento correto
                const modal = document.getElementById('edit-venda-modal');
                modal.style.display = 'block';
                
                // Forçar CSS correto
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.zIndex = '9999';
                
                // Corrigir footer dos botões
                const footer = modal.querySelector('.modal-footer');
                if (footer) {
                    footer.style.position = 'relative';
                    footer.style.bottom = 'auto';
                    footer.style.left = 'auto';
                    footer.style.right = 'auto';
                    footer.style.width = 'auto';
                    footer.style.flexShrink = '0';
                }
                
                document.body.style.overflow = 'hidden';
                
                // Se foi solicitado foco no comprovante, rolar até a seção
                if (focusComprovante) {
                    setTimeout(() => {
                        // Buscar pela seção de comprovante no modal
                        const comprovanteSection = modal.querySelector('div[style*="background: #f8fafc"]');
                        if (comprovanteSection) {
                            comprovanteSection.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                            
                            // Destacar a seção por um momento
                            const originalBorder = comprovanteSection.style.border;
                            const originalBackground = comprovanteSection.style.background;
                            comprovanteSection.style.border = '2px solid #4f46e5';
                            comprovanteSection.style.background = '#eef2ff';
                            comprovanteSection.style.transition = 'all 0.3s ease';
                            
                            setTimeout(() => {
                                comprovanteSection.style.border = originalBorder;
                                comprovanteSection.style.background = originalBackground;
                            }, 2000);
                        }
                    }, 300);
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar venda:', error);
                showNotification('❌ Erro ao carregar venda: ' + error.message, 'error');
            }
        }

        // Função específica para enviar comprovante (abre modal com foco na seção)
        async function enviarComprovante(id) {
            await editVenda(id, true);
        }

        // Função para fechar modal de edição
        function closeEditModal() {
            document.getElementById('edit-venda-modal').style.display = 'none';
        }

        // Event listener para formulário de edição
        document.addEventListener('DOMContentLoaded', function() {
            const editForm = document.getElementById('edit-venda-form');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    try {
                        const vendaId = document.getElementById('edit-venda-id').value;
                        const clienteId = document.getElementById('edit-cliente-id').value;
                        const valorInput = document.getElementById('edit-valor-venda').value;
                        const status = document.getElementById('edit-status-venda').value;
                        const dataVenda = document.getElementById('edit-data-venda').value;
                        const observacao = document.getElementById('edit-descricao-venda').value;
                        // Campo de cupom não existe no modal de edição
                        const cupomCodigo = null;
                        
                        // Validações
                        if (!clienteId) {
                            showNotification('❌ Por favor, selecione um cliente válido', 'error');
                            return;
                        }
                        
                        if (!valorInput) {
                            showNotification('❌ Por favor, informe o valor da venda', 'error');
                            return;
                        }
                        
                        // Converter valor para número
                        const valorBruto = parseFloat(valorInput.replace(/[R$\s.]/g, '').replace(',', '.'));
                        
                        if (isNaN(valorBruto) || valorBruto <= 0) {
                            showNotification('❌ Valor da venda inválido', 'error');
                            return;
                        }
                        
                        const vendaData = {
                            clienteId: parseInt(clienteId),
                            valorBruto: valorBruto,
                            status: status,
                            dataVenda: dataVenda || new Date().toISOString().split('T')[0],
                            observacao: observacao || ''
                        };
                        
                        // Adicionar cupom se selecionado
                        if (cupomCodigo && cupomCodigo.trim() !== '') {
                            vendaData.cupomCodigo = cupomCodigo.trim();
                        }
                        
                        console.log('💾 Atualizando venda:', vendaData);
                        
                        // Enviar para API
                        const response = await fetch(`${API_BASE_URL}/vendas/${vendaId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(vendaData)
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.text();
                            throw new Error(errorData || 'Erro ao atualizar venda');
                        }
                        
                        const result = await response.json();
                        console.log('✅ Venda atualizada:', result);
                        
                        showNotification('✅ Venda atualizada com sucesso!', 'success');
                        
                        // Fechar modal e recarregar dados
                        closeEditModal();
                        await loadVendasData();
                        await loadMetricas();
                        
                    } catch (error) {
                        console.error('❌ Erro ao atualizar venda:', error);
                        showNotification('❌ Erro ao atualizar venda: ' + error.message, 'error');
                    }
                });
            }
        });

        // Fechar modal clicando fora dele
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('edit-venda-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeEditModal();
                    }
                });
            }
        });

        // Variáveis globais para armazenar dados da venda sendo editada
        let currentEditingVendaId = null;
        let currentEditingVendaData = null;

        // Função para upload de comprovante
        async function uploadComprovante() {
            const fileInput = document.getElementById('edit-comprovante-venda');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('⚠️ Selecione um arquivo para upload', 'warning');
                return;
            }
            
            if (!currentEditingVendaId) {
                showNotification('❌ ID da venda não encontrado', 'error');
                return;
            }
            
            // Validar tamanho do arquivo (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('❌ Arquivo muito grande. Máximo 5MB permitido', 'error');
                return;
            }
            
            // Validar tipo do arquivo
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                showNotification('❌ Tipo de arquivo não suportado. Use JPG, PNG ou PDF', 'error');
                return;
            }
            
            try {
                showNotification('📤 Enviando comprovante...', 'info');
                
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE_URL}/vendas/${currentEditingVendaId}/comprovante`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.erro || 'Erro ao enviar comprovante');
                }
                
                const result = await response.json();
                console.log('✅ Comprovante enviado:', result);
                
                showNotification('✅ Comprovante enviado com sucesso!', 'success');
                
                // Atualizar interface
                await updateComprovanteStatus(result.venda);
                
                // Limpar input de arquivo
                fileInput.value = '';
                
                // Recarregar dados das vendas
                await loadVendasData();
                
            } catch (error) {
                console.error('❌ Erro ao enviar comprovante:', error);
                showNotification('❌ Erro ao enviar comprovante: ' + error.message, 'error');
            }
        }

        // Função para remover comprovante
        async function removerComprovante() {
            if (!currentEditingVendaId) {
                showNotification('❌ ID da venda não encontrado', 'error');
                return;
            }
            
            const confirmed = await showConfirmation(
                'O status da venda voltará para PENDENTE.',
                'Tem certeza que deseja remover o comprovante?'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                showNotification('🗑️ Removendo comprovante...', 'info');
                
                const response = await fetch(`${API_BASE_URL}/vendas/${currentEditingVendaId}/comprovante`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.erro || 'Erro ao remover comprovante');
                }
                
                const result = await response.json();
                console.log('✅ Comprovante removido:', result);
                
                showNotification('✅ Comprovante removido com sucesso!', 'success');
                
                // Atualizar interface
                await updateComprovanteStatus(result);
                
                // Recarregar dados das vendas
                await loadVendasData();
                
            } catch (error) {
                console.error('❌ Erro ao remover comprovante:', error);
                showNotification('❌ Erro ao remover comprovante: ' + error.message, 'error');
            }
        }

        // Função para atualizar o status do comprovante na interface
        async function updateComprovanteStatus(vendaData) {
            const statusDiv = document.getElementById('comprovante-status');
            const removeBtn = document.getElementById('remove-comprovante-btn');
            
            if (!statusDiv) return;
            
            const hasComprovante = vendaData.comprovanteAnexado || (vendaData.comprovantePath && vendaData.comprovantePath.trim() !== '');
            
            if (hasComprovante) {
                statusDiv.innerHTML = `
                    <span class="material-icons" style="color: #10b981;">check_circle</span>
                    <span style="color: #10b981;">Comprovante anexado</span>
                    ${vendaData.comprovanteUploadDate ? 
                        `<span style="color: #6b7280; font-size: 0.75rem; margin-left: auto;">
                            ${new Date(vendaData.comprovanteUploadDate).toLocaleDateString('pt-BR')}
                        </span>` : ''}
                `;
                statusDiv.style.background = '#dcfce7';
                statusDiv.style.border = '1px solid #bbf7d0';
                
                if (removeBtn) removeBtn.style.display = 'flex';
            } else {
                statusDiv.innerHTML = `
                    <span class="material-icons" style="color: #f59e0b;">pending</span>
                    <span style="color: #f59e0b;">Comprovante não anexado</span>
                    <span style="color: #6b7280; font-size: 0.75rem; margin-left: auto;">Status: ${vendaData.status || 'PENDENTE'}</span>
                `;
                statusDiv.style.background = '#fef3c7';
                statusDiv.style.border = '1px solid #fde68a';
                
                if (removeBtn) removeBtn.style.display = 'none';
            }
        }

        // Função para processar upload de comprovante ao criar venda
        async function processComprovanteUpload(vendaId) {
            const fileInput = document.getElementById('comprovante-venda');
            const file = fileInput.files[0];
            
            if (!file || !vendaId) return;
            
            try {
                console.log('📤 Processando upload de comprovante para venda:', vendaId);
                
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE_URL}/vendas/${vendaId}/comprovante`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    console.warn('Falha no upload do comprovante, mas venda foi criada');
                    return;
                }
                
                const result = await response.json();
                console.log('✅ Comprovante da nova venda enviado:', result);
                
            } catch (error) {
                console.warn('Erro no upload do comprovante, mas venda foi criada:', error);
            }
        }

        // Função para formatar valor como moeda
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2
            }).format(value);
        }

        // Função para toggle do menu do usuário
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }
        
        // Fechar dropdown quando cliccar fora
        document.addEventListener('click', function(event) {
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');
            
            if (userMenuBtn && userDropdown && !userMenuBtn.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.style.display = 'none';
            }
        });
        
        // Funções do menu do usuário
        function updateUserInfo(usuario) {
            const userName = usuario.nome || usuario.name || 'Usuário';
            const userRole = usuario.tipoUsuario || usuario.role || 'FUNCIONARIO';
            
            // Atualizar nome na navbar
            document.getElementById('userName').textContent = userName.split(' ')[0]; // Primeiro nome
            document.getElementById('userNameDisplay').textContent = userName;
            document.getElementById('userRoleDisplay').textContent = getRoleDisplayName(userRole);
            
            // Atualizar avatar se houver foto de perfil
            if (usuario.profilePhotoPath) {
                const avatarImage = document.getElementById('userAvatarImage');
                const avatarPlaceholder = document.getElementById('userAvatarPlaceholder');
                const photoUrl = `${API_BASE_URL.replace('/api', '')}/uploads/${usuario.profilePhotoPath}`;
                
                avatarImage.src = photoUrl;
                avatarImage.style.display = 'block';
                avatarPlaceholder.style.display = 'none';
                
                avatarImage.onerror = function() {
                    avatarImage.style.display = 'none';
                    avatarPlaceholder.style.display = 'block';
                };
            }
        }
        
        // Carregar dados do usuário
        async function loadUserData() {
            try {
                // Primeiro, tentar buscar dados atualizados do backend
                const userData = localStorage.getItem('maiconsoft_user') || localStorage.getItem('usuarioLogado');
                if (!userData) return;
                
                const user = JSON.parse(userData);
                
                // Tentar buscar dados atualizados do backend se tiver APIService
                if (window.updateUserDataFromBackend) {
                    try {
                        console.log('🔄 [VENDAS] Buscando dados atualizados do backend...');
                        const mergedUser = await updateUserDataFromBackend();
                        if (mergedUser) {
                            const userName = mergedUser.nome || mergedUser.name || 'Usuário';
                            const userRole = mergedUser.tipoUsuario || mergedUser.roleName || mergedUser.role || 'FUNCIONARIO';
                            
                            const userNameEl = document.getElementById('userName');
                            const userNameDisplayEl = document.getElementById('userNameDisplay');
                            const userRoleDisplayEl = document.getElementById('userRoleDisplay');
                            
                            if (userNameEl) userNameEl.textContent = userName.split(' ')[0];
                            if (userNameDisplayEl) userNameDisplayEl.textContent = userName;
                            if (userRoleDisplayEl) userRoleDisplayEl.textContent = getRoleDisplayName(userRole);
                            
                            // Carregar foto de perfil na navbar com dados atualizados
                            loadUserProfilePhoto(mergedUser);
                            
                            console.log('✅ [VENDAS] Dados atualizados do backend aplicados');
                            return;
                        }
                    } catch (apiError) {
                        console.warn('⚠️ [VENDAS] Erro ao buscar dados atualizados, usando dados locais:', apiError);
                    }
                }
                
                // Fallback para dados locais
                const userName = user.nome || user.name || 'Usuário';
                const userRole = user.tipoUsuario || user.roleName || user.role || 'FUNCIONARIO';
                
                const userNameEl = document.getElementById('userName');
                const userNameDisplayEl = document.getElementById('userNameDisplay');
                const userRoleDisplayEl = document.getElementById('userRoleDisplay');
                
                if (userNameEl) userNameEl.textContent = userName.split(' ')[0];
                if (userNameDisplayEl) userNameDisplayEl.textContent = userName;
                if (userRoleDisplayEl) userRoleDisplayEl.textContent = getRoleDisplayName(userRole);
                
                // Carregar foto de perfil na navbar
                loadUserProfilePhoto(user);
                
                console.log('📝 [VENDAS] Usando dados locais para carregar usuário');
            } catch (error) {
                console.error('❌ [VENDAS] Erro ao carregar dados do usuário:', error);
            }
        }
        
        // Função para carregar foto de perfil na navbar
        function loadUserProfilePhoto(user) {
            const avatarImage = document.getElementById('userAvatarImage');
            const avatarPlaceholder = document.getElementById('userAvatarPlaceholder');
            
            console.log('🔄 [VENDAS] Carregando foto de perfil:', {
                user: user,
                profilePhotoPath: user?.profilePhotoPath,
                avatarImage: !!avatarImage,
                avatarPlaceholder: !!avatarPlaceholder
            });
            
            if (!avatarImage || !avatarPlaceholder) {
                console.warn('❌ [VENDAS] Elementos da navbar não encontrados');
                return;
            }
            
            if (user?.profilePhotoPath) {
                // Usar mesma lógica das outras páginas que funcionam
                const baseURL = window.APIService?.baseURL || window.API_BASE_URL || 'http://localhost:8090/api';
                const imageUrl = `${baseURL.replace('/api', '')}/${user.profilePhotoPath}`;
                
                console.log('🖼️ [VENDAS] URL da imagem construída:', imageUrl);
                
                // Limpar eventos anteriores
                avatarImage.onload = null;
                avatarImage.onerror = null;
                
                // Configurar eventos de carregamento
                avatarImage.onload = () => {
                    console.log('✅ [VENDAS] Foto carregada com sucesso');
                    avatarImage.style.display = 'block';
                    avatarPlaceholder.style.display = 'none';
                };
                
                avatarImage.onerror = () => {
                    console.warn('❌ [VENDAS] Erro ao carregar foto de perfil na navbar:', imageUrl);
                    avatarImage.style.display = 'none';
                    avatarPlaceholder.style.display = 'flex';
                    const firstLetter = (user?.nome || user?.name || 'U').charAt(0).toUpperCase();
                    avatarPlaceholder.textContent = firstLetter;
                };
                
                avatarImage.src = imageUrl;
            } else {
                console.log('📝 [VENDAS] Usando placeholder - sem foto de perfil definida');
                // Mostrar placeholder com inicial do nome
                avatarImage.style.display = 'none';
                avatarPlaceholder.style.display = 'flex';
                
                const firstLetter = (user?.nome || user?.name || 'U').charAt(0).toUpperCase();
                avatarPlaceholder.textContent = firstLetter;
                avatarPlaceholder.style.fontSize = '0.8rem';
            }
        }
        
        // Função para obter nome do cargo
        function getRoleDisplayName(role) {
            const roles = {
                'FUNCIONARIO': 'Funcionário',
                'VENDEDOR': 'Vendedor',
                'SUPERVISOR': 'Supervisor',
                'GERENTE': 'Gerente',
                'DIRETOR': 'Diretor',
                'ADMIN': 'Administrador'
            };
            return roles[role] || role || 'Funcionário';
        }

        // Format currency input
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            
            const valorInput = document.getElementById('valor-venda');
            if (valorInput) {
                valorInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 0) {
                        value = (value / 100).toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        });
                        e.target.value = value;
                    }
                });
            }
        });
    </script>
</body>
</html>